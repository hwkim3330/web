<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>S32G Pro Control Deck</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <style>
        :root {
            --bg-base: #1d1d1f; --bg-panel: #2c2c2e; --border-color: #424245; --text-primary: #f5f5f7;
            --text-secondary: #a1a1a6; --accent-blue: #0a84ff; --accent-blue-hover: #0077ed;
            --accent-red: #ff453a; --accent-red-hover: #ff3428;
        }
        body, html { height: 100%; margin: 0; padding: 0; background-color: var(--bg-base); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; overflow: hidden; }
        #page-container { display: flex; height: 100vh; }
        #gui-pane { flex: 1; min-width: 480px; max-width: 550px; background-color: var(--bg-base); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; }
        #terminal-pane { flex: 2; min-width: 0; display: flex; flex-direction: column; }
        .gui-header { padding: 16px; border-bottom: 1px solid var(--border-color); }
        .gui-header h1 { margin: 0; font-size: 24px; font-weight: 600; }
        .gui-header p { margin: 4px 0 0; color: var(--text-secondary); }
        .gui-main { overflow-y: auto; padding: 16px; flex-grow: 1; }
        #controls { padding: 12px 16px; background-color: var(--bg-panel); display: flex; gap: 10px; align-items: center; border-bottom: 1px solid var(--border-color); }
        #terminal-container { flex-grow: 1; padding: 5px; }
        .gui-section { margin-bottom: 20px; background-color: var(--bg-panel); border-radius: 12px; border: 1px solid var(--border-color); }
        .gui-section h3 { display: flex; align-items: center; gap: 8px; padding: 12px 16px; margin: 0; font-size: 1em; font-weight: 600; border-bottom: 1px solid var(--border-color); }
        .gui-section .content { padding: 16px; display: flex; flex-direction: column; gap: 14px; }
        .input-group { display: flex; gap: 10px; align-items: center; }
        button, select, input, textarea { width: 100%; background-color: #3e3e40; color: var(--text-primary); border: 1px solid #545458; padding: 9px 12px; border-radius: 8px; font-family: inherit; font-size: 14px; box-sizing: border-box; transition: all 0.2s ease; }
        ::placeholder { color: var(--text-secondary); }
        button { cursor: pointer; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 8px; background-color: #515154; }
        button:hover:not(:disabled) { background-color: #646467; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .action-btn { background-color: var(--accent-blue); border-color: var(--accent-blue); }
        .action-btn:hover:not(:disabled) { background-color: var(--accent-blue-hover); }
        .stop-btn { background-color: var(--accent-red); border-color: var(--accent-red); }
        .stop-btn:hover:not(:disabled) { background-color: var(--accent-red-hover); }
        #status { margin-top: 5px; font-size: 0.9em; min-height: 1.2em; text-align: center; color: var(--text-secondary); }
        hr { border: none; height: 1px; background-color: var(--border-color); margin: 4px 0; }
        @media (max-width: 1200px) { #gui-pane { display: none; } }
    </style>
</head>
<body>
<div id="page-container">
    <div id="gui-pane">
        <header class="gui-header"><h1>S32G Control Deck</h1><p>Professional Web Interface for NXP S32G3</p></header>
        <main class="gui-main">
            <section class="gui-section"><h3><svg width="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10s-2 2-5 2-5-2-5-2"/><path d="M3 10s2 2 5 2 5-2 5-2"/><path d="M12 2a2.5 2.5 0 0 1 2.5 2.5V10"/><path d="M12 14v7.5a2.5 2.5 0 0 1-5 0V14"/><line x1="7" y1="10" x2="7" y2="14"/><line x1="17" y1="10" x2="17" y2="14"/></svg>Management Port (end0)</h3><div class="content"><p style="color: var(--text-secondary); margin: -10px 0 5px; font-size: 13px;">One-click setup for interface <strong>end0</strong>.</p><button id="setupGmacBtn" class="action-btn">1. Set Board IP (169.254.59.171)</button><button id="pingHostBtn" class="action-btn">2. Ping Host (169.254.59.170)</button></div></section>
            <section class="gui-section"><h3><svg width="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/><path d="M12 12a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>One-Click TSN Demo</h3><div class="content"><p style="color: var(--text-secondary); margin: -10px 0 5px; font-size: 13px;">Configures MQPRIO, CBS, and PTP on <strong>end0</strong>.</p><button id="tsnDemoBtn" class="action-btn">▶️ Start TSN Demo</button><button id="stopTsnDemoBtn" class="stop-btn">⏹️ Stop & Clean Up</button></div></section>
            <section class="gui-section"><h3><svg width="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20v-6M6 20v-2M18 20v-4"/><path d="M12 14v-4M6 14V8M18 14v-2"/></svg>Advanced PTP Control</h3><div class="content"><div class="input-group"><input id="ptp4lIfaceInput" type="text" value="end0" placeholder="Iface"><select id="ptp4lTsSelect" style="width: auto;"><option value="-H">HW</option><option value="-S">SW</option></select><select id="ptp4lTransportSelect" style="width: auto;"><option value="-2">L2</option><option value="-4">UDPv4</option></select><input id="ptp4lDomainInput" type="number" value="0" style="width: 80px;" title="Domain"></div><div class="input-group"><button id="runPtp4lBtn" class="action-btn">▶️ Start PTP</button><button class="cmd-btn stop-btn" data-cmd="killall ptp4l">⏹️ Stop</button></div></div></section>
            <section class="gui-section"><h3><svg width="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8V2l11.16 11.16M22 8a5 5 0 0 0-3.9-3.9M14.05 6A9 9 0 0 1 22 13.95M22 22V16"/></svg>Advanced TC (taprio)</h3><div class="content"><div class="input-group"><label>Iface:</label><input id="tcIfaceInput" value="end0"><label>Num TC:</label><input id="tcNumTcInput" type="number" value="5" style="width:80px"></div><textarea id="tcSchedEntryTextarea" rows="3" placeholder="One sched-entry per line">sched-entry S 1e 500000
sched-entry S 01 500000</textarea><div class="input-group"><button id="runTcBtn" class="action-btn">Apply Qdisc</button><button id="deleteTcBtn" class="stop-btn">Delete Qdisc</button></div></div></section>
            <section class="gui-section"><h3><svg width="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.2 15c.7-1.2 1-2.5.7-3.9-.6-2.4-2.2-4.4-4.6-5.5-.9-.4-1.8-.7-2.8-.8A4.94 4.94 0 0 0 12 2a4.95 4.95 0 0 0-4.5 3c-1.1.1-2.2.4-3.1.8-2.3 1.1-4 3.1-4.6 5.5-.3 1.4 0 2.7.7 3.9l.6.9.2.5H20.4l.2-.5.6-.9z"/></svg>File Transfer</h3><div class="content"><div class="input-group"><input type="file" id="fileInput"><button id="uploadFileBtn" class="action-btn">⬆️ Upload</button></div><div class="input-group"><input id="remotePathInput" placeholder="/tmp/uploaded_file"></div><hr><div class="input-group"><input id="downloadPathInput" placeholder="/tmp/capture.pcap"><button id="downloadFileBtn" class="action-btn">⬇️ Download</button></div><div id="status"></div></div></section>
            <section class="gui-section"><h3><svg width="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M3 20h2"/><path d="M18 4H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/><path d="M12 16v4"/><path d="M9 20h.01"/><path d="M6 20h.01"/></svg>CAN Bus</h3><div class="content"><div class="input-group"><button class="cmd-btn" data-cmd="ip -s link show can0">CAN0 Stats</button><button class="cmd-btn" data-cmd="ip -s link show can1">CAN1 Stats</button></div><hr><div class="input-group"><input id="candumpInput" value="any" placeholder="Iface"><button id="runCandumpBtn" class="action-btn">▶️ Sniff</button><button class="cmd-btn stop-btn" data-cmd="killall candump">⏹️ Stop</button></div><hr><div class="input-group"><input id="cansendInput" value="can0 123#112233" placeholder="<iface> <id>#<data>"><button id="sendCanBtn" class="action-btn">Send</button></div></div></section>
        </main>
    </div>
    <div id="terminal-pane">
        <div id="controls"><button id="connectBtn" style="background-color: #34c759;">Connect</button><button id="disconnectBtn" disabled style="background-color: #8e8e93;">Disconnect</button><select id="baudRateSelect"><option value="115200">115200</option><option value="9600">9600</option></select><button id="rootLoginBtn" class="action-btn" disabled>Login as root</button><button id="clearTermBtn" style="margin-left: auto;">Clear</button></div>
        <div id="terminal-container"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const App = {
        state: { port: null, reader: null, writer: null, isReading: false, onDataDisposable: null, fileDownloadInProgress: false, fileDownloadBuffer: '', },
        ui: {},
        term: new Terminal({ cursorBlink: true, fontFamily: 'Menlo, Monaco, "Courier New", monospace', fontSize: 14, theme: { background: '#1d1d1f', foreground: '#f5f5f7', cursor: '#0a84ff', selectionBackground: 'rgba(10, 132, 255, 0.3)' }, allowTransparency: false }),
        fitAddon: new FitAddon.FitAddon(),

        init() { if (!navigator.serial) { alert("Web Serial API is not supported."); return; } this.cacheUI(); this.setupTerminal(); this.setGuiEnabled(false); this.bindEvents(); },
        cacheUI() {
            const ids = [
                'connectBtn', 'disconnectBtn', 'baudRateSelect', 'rootLoginBtn', 'clearTermBtn', 'terminal-container',
                'setupGmacBtn', 'pingHostBtn', 'tsnDemoBtn', 'stopTsnDemoBtn',
                'ptp4lIfaceInput', 'ptp4lTsSelect', 'ptp4lTransportSelect', 'ptp4lDomainInput', 'runPtp4lBtn',
                'tcIfaceInput', 'tcNumTcInput', 'tcSchedEntryTextarea', 'runTcBtn', 'deleteTcBtn',
                'candumpInput', 'runCandumpBtn', 'cansendInput', 'sendCanBtn',
                'killPidInput', 'killBtn',
                'fileInput', 'remotePathInput', 'uploadFileBtn', 'downloadPathInput', 'downloadFileBtn', 'status',
            ];
            ids.forEach(id => { const el = document.getElementById(id); this.ui[id.replace(/-/g, '')] = el; });
            this.ui.cmdBtns = document.querySelectorAll('.cmd-btn');
            this.ui.guiControls = document.querySelectorAll('#gui-pane button, #gui-pane input, #gui-pane select, #gui-pane textarea, #rootLoginBtn');
        },
        setupTerminal() { this.term.loadAddon(this.fitAddon); this.term.open(this.ui.terminalcontainer); this.fitAddon.fit(); new ResizeObserver(() => this.fitAddon.fit()).observe(this.ui.terminalcontainer); },
        setGuiEnabled(enabled) { this.ui.guiControls.forEach(c => c.disabled = !enabled); this.ui.connectBtn.disabled = enabled; this.ui.disconnectBtn.disabled = !enabled; this.ui.baudRateSelect.disabled = enabled; },
        async sendSerial(data) { if (!this.state.port?.writable) return; try { const writer = this.state.port.writable.getWriter(); await writer.write(new TextEncoder().encode(data)); writer.releaseLock(); } catch (e) { this.term.writeln(`\r\n\x1b[31m[E] Write failed: ${e.message}\x1b[0m`); } },
        async sendCommand(cmd, showInTerm = true) { if (this.state.port && cmd) { this.term.focus(); if(showInTerm) this.term.writeln(`\x1b[38;5;69m$ ${cmd}\x1b[0m`); await this.sendSerial(cmd + '\r'); } },
        delay(ms) { return new Promise(resolve => setTimeout(resolve, ms)); },
        async connect() { if (this.state.port) return; try { this.state.port = await navigator.serial.requestPort(); await this.state.port.open({ baudRate: parseInt(this.ui.baudRateSelect.value, 10) }); this.setGuiEnabled(true); this.state.isReading = true; this.readLoop(); this.term.writeln('\x1b[32m[SYSTEM] Connected.\x1b[0m'); this.term.focus(); this.state.onDataDisposable = this.term.onData(data => { if (!this.state.fileDownloadInProgress) { this.sendSerial(data); } }); } catch (error) { this.term.writeln(`\r\n\x1b[31m[E] ${error.message}\x1b[0m`); this.state.port = null; } },
        async disconnect() { const portToClose = this.state.port; if (!portToClose) return; this.state.isReading = false; if (this.state.onDataDisposable) { this.state.onDataDisposable.dispose(); this.state.onDataDisposable = null; } if (this.state.reader) { try { await this.state.reader.cancel(); } catch (e) {} } try { await portToClose.close(); } catch (e) {} if (this.state.port === portToClose) { this.state.port = null; this.state.reader = null; this.setGuiEnabled(false); this.term.writeln('\r\n\x1b[33m[SYSTEM] Disconnected.\x1b[0m'); } },
        async readLoop() { while (this.state.port?.readable && this.state.isReading) { const textDecoder = new TextDecoder(); this.state.reader = this.state.port.readable.getReader(); try { while (true) { const { value, done } = await this.state.reader.read(); if (done) { this.state.reader.releaseLock(); break; } const decodedChunk = textDecoder.decode(value, { stream: true }); if (this.state.fileDownloadInProgress) { this.handleFileDownloadChunk(decodedChunk); } else { this.term.write(decodedChunk); } } } catch (error) { if (this.state.isReading) { this.term.writeln(`\r\n\x1b[31m[E] Read loop: ${error.message}\x1b[0m`); } } } },
        handleFileUpload() { const file = this.ui.fileInput.files[0]; const remotePath = this.ui.remotePathInput.value.trim(); if (!file || !remotePath) { this.ui.status.textContent = "Select file and enter path."; return; } const reader = new FileReader(); this.ui.status.textContent = `Reading ${file.name}...`; this.ui.uploadFileBtn.disabled = true; reader.onload = (e) => { const base64Content = e.target.result.split(',')[1]; const cmd = `echo '${base64Content}' | base64 -d > ${remotePath}`; this.ui.status.textContent = `Uploading...`; this.sendCommand(cmd, false).then(() => { this.ui.status.textContent = 'Upload initiated.'; }); }; reader.onloadend = () => { this.ui.uploadFileBtn.disabled = false; }; reader.onerror = (err) => { this.ui.status.textContent = `Error reading file.`; }; reader.readAsDataURL(file); },
        handleFileDownload() { const path = this.ui.downloadPathInput.value.trim(); if (!path) { this.ui.status.textContent = 'Enter a file path.'; return; } if (this.state.fileDownloadInProgress) { this.ui.status.textContent = 'Download in progress.'; return; } this.state.fileDownloadInProgress = true; this.state.fileDownloadBuffer = ''; this.ui.status.textContent = `Requesting ${path}...`; this.sendCommand(`if [ -f "${path}" ]; then cat "${path}" | base64; echo; fi; echo "DOWNLOAD_END"`, false); },
        handleFileDownloadChunk(chunk) { this.state.fileDownloadBuffer += chunk; const endMarker = 'DOWNLOAD_END'; if (this.state.fileDownloadBuffer.includes(endMarker)) { const fileData = this.state.fileDownloadBuffer.substring(0, this.state.fileDownloadBuffer.indexOf(endMarker)).trim(); this.state.fileDownloadInProgress = false; this.state.fileDownloadBuffer = ''; if (fileData.length === 0) { this.term.writeln('\r\n\x1b[33m[W] Download failed (file not found or empty).\x1b[0m'); this.ui.status.textContent = 'Download failed.'; return; } this.ui.status.textContent = 'Decoding...'; this.saveDownloadedFile(fileData); } },
        saveDownloadedFile(base64Data) { try { const byteCharacters = atob(base64Data); const byteArray = new Uint8Array(byteCharacters.length); for (let i = 0; i < byteCharacters.length; i++) { byteArray[i] = byteCharacters.charCodeAt(i); } const blob = new Blob([byteArray]); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); const filename = this.ui.downloadPathInput.value.split('/').pop() || 'downloaded_file'; link.download = filename; link.click(); link.remove(); this.ui.status.textContent = `File "${filename}" downloaded.`; } catch (e) { this.term.writeln(`\r\n\x1b[31m[E] Decode/save failed: ${e.message}\x1b[0m`); this.ui.status.textContent = 'Error: Failed to decode.'; } },

        bindEvents() {
            this.ui.connectBtn.addEventListener('click', () => this.connect());
            this.ui.disconnectBtn.addEventListener('click', () => this.disconnect());
            this.ui.clearTermBtn.addEventListener('click', () => this.term.clear());
            this.ui.rootLoginBtn.addEventListener('click', () => this.sendCommand('root', true));
            this.ui.cmdBtns.forEach(b => b.addEventListener('click', () => this.sendCommand(b.dataset.cmd)));
            
            this.ui.setupGmacBtn.addEventListener('click', () => this.sendCommand(`ip addr add 169.254.59.171/16 dev end0`));
            this.ui.pingHostBtn.addEventListener('click', () => this.sendCommand(`ping -c 4 169.254.59.170`));
            
            this.ui.tsnDemoBtn.addEventListener('click', async () => {
                const iface = 'end0';
                this.term.writeln('\x1b[34m[INFO] Starting One-Click TSN Demo sequence on end0...\x1b[0m');
                await this.sendCommand(`tc qdisc add dev ${iface} root handle 1: mqprio num_tc 4 map 2 2 1 1 2 2 2 2 2 2 2 2 2 2 2 2 queues 1@1 1@2 1@3 hw 0`);
                await this.delay(500);
                await this.sendCommand(`tc qdisc add dev ${iface} parent 1:2 cbs idleslope 50000 sendslope -950000 hicredit 52 locredit -144 offload 1`);
                await this.delay(500);
                await this.sendCommand(`ptp4l -i ${iface} -2 -H -m &`);
                this.term.writeln('\x1b[32m[SUCCESS] TSN Demo initiated.\x1b[0m');
            });

            this.ui.stopTsnDemoBtn.addEventListener('click', async () => {
                const iface = 'end0';
                this.term.writeln('\x1b[33m[INFO] Stopping TSN Demo and cleaning up...\x1b[0m');
                await this.sendCommand(`killall ptp4l`); await this.delay(200);
                await this.sendCommand(`tc qdisc del dev ${iface} root`);
                this.term.writeln('\x1b[32m[SUCCESS] Cleanup complete.\x1b[0m');
            });

            this.ui.runPtp4lBtn.addEventListener('click', () => {
                const i = this.ui.ptp4lIfaceInput.value.trim(); const ts = this.ui.ptp4lTsSelect.value;
                const t = this.ui.ptp4lTransportSelect.value; const d = this.ui.ptp4lDomainInput.value.trim();
                if(i) this.sendCommand(`ptp4l -i ${i} ${ts} ${t} -d ${d} -m &`);
            });

            this.ui.runTcBtn.addEventListener('click', () => {
                const iface = this.ui.tcIfaceInput.value.trim(); const num_tc = this.ui.tcNumTcInput.value.trim();
                const sched_entries = this.ui.tcSchedEntryTextarea.value.trim().split('\n').map(line => line.trim()).filter(line => line.length > 0).join(' ');
                if (!iface || !num_tc || !sched_entries) { this.ui.status.textContent = "TC fields cannot be empty."; return; }
                const map_str = Array.from({length: 16}, () => 0).join(' '); // Default map, can be configured if needed
                const queues_str = Array.from({length: parseInt(num_tc)}, (_, i) => `1@${i}`).join(' ');
                const cmd = `tc qdisc replace dev ${iface} parent root handle 100 taprio num_tc ${num_tc} map ${map_str} queues ${queues_str} base-time 0 ${sched_entries} flags 0x2`;
                this.sendCommand(cmd);
            });
            this.ui.deleteTcBtn.addEventListener('click', () => { const iface = this.ui.tcIfaceInput.value.trim(); if (iface) this.sendCommand(`tc qdisc del dev ${iface} root`); });
            
            this.ui.runCandumpBtn.addEventListener('click', () => { const i = this.ui.candumpInput.value.trim(); if(i) this.sendCommand(`candump ${i} &`); });
            this.ui.sendCanBtn.addEventListener('click', () => { const c = this.ui.cansendInput.value.trim(); if(c) this.sendCommand(`cansend ${c}`); });
            this.ui.killBtn.addEventListener('click', () => { const p = this.ui.killPidInput.value.trim(); if(p && confirm(`Kill PID ${p}?`)) this.sendCommand(`kill -9 ${p}`); });
            this.ui.uploadFileBtn.addEventListener('click', () => this.handleFileUpload());
            this.ui.downloadFileBtn.addEventListener('click', () => this.handleFileDownload());
        }
    };
    App.init();
});
</script>
</body>
</html>
