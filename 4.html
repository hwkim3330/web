<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>S32G professional control center - Functional Core Edition</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

<style>
:root {
    --bg-base: #202124; --bg-pane: #2d2e30; --bg-element: #3c3d40;
    --border-color: #4a4a4f; --text-primary: #e8eaed; --text-secondary: #bdc1c6;
    --accent-blue: #8ab4f8; --accent-green: #34a853; --accent-yellow: #fbbc05; --accent-red: #ea4335;
}

html, body {
    height: 100%; margin: 0; padding: 0; background-color: var(--bg-base); color: var(--text-primary);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden;
}

#page-container { display: flex; flex-direction: column; height: 100%; }
#controls { padding: 8px 15px; background-color: var(--bg-pane); flex-shrink: 0; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; }
#main-content { display: flex; flex-grow: 1; min-height: 0; }
#terminal-pane { flex: 1.5; min-width: 0; display: flex; flex-direction: column; }
#gui-pane { flex: 1; overflow-y: auto; background-color: var(--bg-base); padding: 5px 15px 15px 15px; }

#terminal-container { flex-grow: 1; padding: 10px; overflow: hidden; }

button, select, input {
    background-color: var(--bg-element); color: var(--text-primary); border: 1px solid var(--border-color);
    padding: 8px 12px; font-size: 13px; cursor: pointer; border-radius: 6px; transition: background-color 0.2s;
    display: flex; align-items: center; gap: 6px; font-weight: 500;
}
button:hover:not(:disabled) { background-color: #4a4b4e; }
button:disabled { background-color: #313235; color: #888; cursor: not-allowed; }
.primary-btn { background-color: var(--accent-blue); border-color: var(--accent-blue); color: #202124; }
.primary-btn:hover:not(:disabled) { background-color: #a2c6ff; }

.gui-section { margin-bottom: 15px; background-color: var(--bg-pane); border: 1px solid var(--border-color); border-radius: 8px; }
.gui-section h3 {
    font-size: 14px; font-weight: 600; color: var(--accent-blue); padding: 10px 12px; margin: 0;
    border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 8px;
}
.gui-section .content { padding: 12px; }
.button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; }
.input-group { display: flex; gap: 8px; margin-top: 10px; }
.input-group input { flex-grow: 1; width: 100%; box-sizing: border-box; }
.input-group button { flex-shrink: 0; width: auto; justify-content: center; }

@media (max-width: 1200px) {
    #gui-pane { display: none; }
}
</style>
</head>
<body>
  <div id="page-container">
    <div id="controls">
        <button id="connectBtn" class="primary-btn"><i data-lucide="zap"></i>Connect</button>
        <button id="disconnectBtn" disabled style="background-color: var(--accent-red); border:none; color:white;"><i data-lucide="zap-off"></i>Disconnect</button>
        <select id="baudRateSelect" style="width:auto;">
            <option value="115200" selected>115200</option><option value="57600">57600</option><option value="9600">9600</option>
        </select>
        <button id="rootLoginBtn" class="primary-btn" disabled><i data-lucide="user-cog"></i>Login as root</button>
        <button id="clearTermBtn" style="margin-left: auto;"><i data-lucide="trash-2"></i>Clear</button>
    </div>
    <div id="main-content">
        <div id="terminal-pane">
            <div id="terminal-container"></div>
        </div>
        <div id="gui-pane">
            <div class="gui-section">
                <h3><i data-lucide="network"></i>Network & Interface</h3>
                <div class="content">
                    <div class="button-grid">
                        <button class="cmd-btn" data-cmd="ip -c a">IP Addresses</button>
                        <button class="cmd-btn" data-cmd="ip -s link">Link Stats</button>
                        <button class="cmd-btn" data-cmd="ip route">Routing Table</button>
                        <button class="cmd-btn" data-cmd="brctl show">Show Bridges</button>
                    </div>
                     <div class="input-group">
                        <input id="netIfaceInput" type="text" value="end0" placeholder="Interface">
                        <button id="ifaceUpBtn">UP</button>
                        <button id="ifaceDownBtn">DOWN</button>
                    </div>
                     <div class="input-group">
                        <input id="ipAddressInput" type="text" placeholder="e.g., 192.168.1.10/24">
                        <button id="setIpBtn">Set IP</button>
                    </div>
                </div>
            </div>
            <div class="gui-section">
                <h3><i data-lucide="settings-2"></i>Ethtool & TSN</h3>
                <div class="content">
                    <div class="input-group">
                        <select id="ethtoolParamSelect" style="flex-grow: 2;">
                            <option value="-T">Timestamping Caps (-T)</option>
                            <option value="-S">Statistics (-S)</option>
                            <option value="-k">Features (-k)</option>
                            <option value="-a">Pause Frames (-a)</option>
                        </select>
                        <button id="runEthtoolBtn">Run Ethtool</button>
                    </div>
                    <div class="input-group">
                        <input id="tcpdumpInput" type="text" value="-i end0 -c 10" placeholder="tcpdump options">
                        <button id="runTcpdumpBtn">Run tcpdump</button>
                    </div>
                    <div class="button-grid" style="margin-top: 10px;">
                        <button class="cmd-btn" data-cmd="ptp4l -2 -H -m -s -i end0">PTP4L Sync</button>
                        <button class="cmd-btn" data-cmd="tc qdisc add dev end0 root handle 1: mqprio hw 0 num_tc 5 map 1 1 2 3 4 queues 1@0 1@1 1@2 1@3 1@4">MQPRIO Example</button>
                    </div>
                </div>
            </div>
            <div class="gui-section">
                <h3><i data-lucide="bus-front"></i>CAN Bus</h3>
                <div class="content">
                    <div class="button-grid">
                        <button class="cmd-btn" data-cmd="ip -s link show can0">CAN0 Stats</button>
                        <button class="cmd-btn" data-cmd="ip -s link show can1">CAN1 Stats</button>
                        <button class="cmd-btn" data-cmd="candump any">Sniff CAN</button>
                    </div>
                    <div class="input-group">
                        <input id="cansendInput" type="text" value="can0 123#112233" placeholder="<iface> <id>#<data>">
                        <button id="sendCanBtn">Send Frame</button>
                    </div>
                </div>
            </div>
            <div class="gui-section">
                <h3><i data-lucide="cpu"></i>System & File</h3>
                <div class="content">
                    <div class="button-grid">
                        <button class="cmd-btn" data-cmd="ps aux">Processes</button>
                        <button class="cmd-btn" data-cmd="top -b -n 1">Top</button>
                        <button class="cmd-btn" data-cmd="free -h">Memory</button>
                        <button class="cmd-btn" data-cmd="df -h">Disk</button>
                        <button class="cmd-btn" data-cmd="ls -lha /">List Root Dir</button>
                        <button class="cmd-btn" data-cmd="dmesg | tail -n 50">dmesg</button>
                    </div>
                    <div class="input-group">
                        <input id="filePathInput" type="text" placeholder="/path/to/remote/file">
                        <button id="downloadFileBtn">Download File</button>
                    </div>
                </div>
            </div>
             <div class="gui-section">
                <h3><i data-lucide="shield"></i>Firewall</h3>
                <div class="content">
                    <div class="button-grid">
                        <button class="cmd-btn" data-cmd="iptables -L -n -v">List iptables Rules</button>
                    </div>
                </div>
            </div>
            <div class="gui-section">
                <h3><i data-lucide="power-circle"></i>System Control</h3>
                <div class="content">
                    <div class="button-grid">
                        <button id="rebootBtn" style="background-color: var(--accent-yellow); color: var(--bg-base);"><i data-lucide="refresh-cw"></i>Reboot</button>
                        <button id="poweroffBtn" style="background-color: var(--accent-red); color: white;"><i data-lucide="power-off"></i>Power Off</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            state: { port: null, isReading: false, onDataDisposable: null, fileDownloadInProgress: false, fileDownloadBuffer: '' },
            ui: {},
            term: null,
            fitAddon: null,

            init() {
                if (!navigator.serial) {
                    alert("Web Serial API is not supported. Please use a modern browser like Chrome or Edge.");
                    return;
                }
                this.cacheUI();
                
                this.term = new Terminal({
                    cursorBlink: true, fontFamily: 'Menlo, Monaco, "Courier New", monospace', fontSize: 14,
                    theme: { background: '#202124', foreground: '#e8eaed', cursor: '#8ab4f8', selectionBackground: 'rgba(138, 180, 248, 0.3)' }
                });
                this.fitAddon = new FitAddon.FitAddon();
                this.term.loadAddon(this.fitAddon);
                this.term.open(this.ui.terminalContainer);
                this.fitAddon.fit();
                new ResizeObserver(() => this.fitAddon.fit()).observe(this.ui.terminalContainer);
                
                this.setGuiEnabled(false);
                this.bindEvents();
                lucide.createIcons();
            },
            
            cacheUI() {
                const ids = [
                    'connectBtn', 'disconnectBtn', 'baudRateSelect', 'clearTermBtn', 'rootLoginBtn', 
                    'terminalContainer', 'guiPane',
                    'netIfaceInput', 'ifaceUpBtn', 'ifaceDownBtn', 'ipAddressInput', 'setIpBtn',
                    'ethtoolParamSelect', 'ethtoolIfaceInput', 'runEthtoolBtn', 'tcpdumpInput', 'runTcpdumpBtn',
                    'runPtp4lBtn', 'runMqprioBtn', 'runTaprioBtn',
                    'canBitrateInput', 'setCan0Btn', 'setCan1Btn', 'cansendInput', 'sendCanBtn',
                    'filePathInput', 'downloadFileBtn',
                    'rebootBtn', 'poweroffBtn'
                ];
                ids.forEach(id => this.ui[id] = document.getElementById(id));
                this.ui.cmdBtns = document.querySelectorAll('.cmd-btn');
                this.ui.guiControls = document.querySelectorAll('#gui-pane button, #gui-pane input, #gui-pane select');
            },

            setGuiEnabled(enabled) {
                this.ui.guiControls.forEach(c => c.disabled = !enabled);
                this.ui.connectBtn.disabled = enabled;
                this.ui.disconnectBtn.disabled = !enabled;
                this.ui.baudRateSelect.disabled = enabled;
            },

            async sendSerial(data) {
                if (!this.state.port?.writable) return;
                try {
                    const writer = this.state.port.writable.getWriter();
                    await writer.write(new TextEncoder().encode(data));
                    writer.releaseLock();
                } catch (e) { this.term.writeln(`\r\n\x1b[31m[ERROR] Write failed: ${e.message}\x1b[0m`); }
            },

            async sendCommand(cmd, showInTerm = true) {
                if (this.state.port && cmd) {
                    this.term.focus();
                    if(showInTerm) this.term.writeln(`\x1b[36m$ ${cmd}\x1b[0m`);
                    await this.sendSerial(cmd + '\r');
                }
            },
            
            async connect() {
                try {
                    this.state.port = await navigator.serial.requestPort();
                    await this.state.port.open({ baudRate: parseInt(this.ui.baudRateSelect.value, 10) });
                    this.setGuiEnabled(true);
                    this.state.isReading = true;
                    this.readLoop();
                    this.term.writeln('\x1b[32m[SYSTEM] Connected to Serial Port.\x1b[0m');
                    this.term.focus();
                    this.state.onDataDisposable = this.term.onData(data => {
                        if (!this.state.fileDownloadInProgress) {
                            this.sendSerial(data);
                        }
                    });
                } catch (error) { this.term.writeln(`\r\n\x1b[31m[ERROR] ${error.message}\x1b[0m`); }
            },
            
            async disconnect() {
                const portToClose = this.state.port; if (!portToClose) return;
                this.state.isReading = false;
                if (this.state.onDataDisposable) { this.state.onDataDisposable.dispose(); this.state.onDataDisposable = null; }
                if (portToClose.readable) {
                    try {
                        const reader = portToClose.readable.getReader();
                        await reader.cancel(); 
                        reader.releaseLock();
                    } catch(e) {}
                }
                try { await portToClose.close(); } catch(e) {}
                if (this.state.port === portToClose) {
                    this.state.port = null; this.setGuiEnabled(false);
                    this.term.writeln('\r\n\x1b[33m[SYSTEM] Disconnected.\x1b[0m');
                }
            },
            
            async readLoop() {
                const textDecoder = new TextDecoder();
                while (this.state.port?.readable && this.state.isReading) {
                    const reader = this.state.port.readable.getReader();
                    try {
                        while (true) {
                            const { value, done } = await reader.read();
                            if (done) break;
                            const decodedChunk = textDecoder.decode(value, { stream: true });
                            if (this.state.fileDownloadInProgress) {
                                this.handleFileDownloadChunk(decodedChunk);
                            } else {
                                this.term.write(decodedChunk);
                            }
                        }
                    } catch (error) {
                        if (this.state.isReading) this.term.writeln(`\r\n\x1b[31m[ERROR] Read loop failed: ${error.message}\x1b[0m`);
                    } finally { reader.releaseLock(); }
                }
            },

            handleFileDownloadChunk(chunk) {
                this.state.fileDownloadBuffer += chunk;
                const endMarker = 'DOWNLOAD_END';
                if (this.state.fileDownloadBuffer.includes(endMarker)) {
                    const fileData = this.state.fileDownloadBuffer.substring(0, this.state.fileDownloadBuffer.indexOf(endMarker)).trim();
                    this.state.fileDownloadInProgress = false;
                    this.term.writeln('\r\n\x1b[32m[SYSTEM] Base64 data received. Processing...\x1b[0m');
                    this.saveDownloadedFile(fileData);
                    this.state.fileDownloadBuffer = '';
                }
            },

            saveDownloadedFile(base64Data) {
                try {
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray]);
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    const filename = this.ui.filePathInput.value.split('/').pop() || 'downloaded_file';
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    this.term.writeln(`\x1b[32m[SYSTEM] File "${filename}" downloaded successfully.\x1b[0m`);
                } catch (e) {
                    this.term.writeln(`\x1b[31m[ERROR] Failed to decode or save file: ${e.message}\x1b[0m`);
                }
            },

            bindEvents() {
                this.ui.connectBtn.addEventListener('click', () => this.connect());
                this.ui.disconnectBtn.addEventListener('click', () => this.disconnect());
                navigator.serial?.addEventListener('disconnect', (e) => { if (e.target === this.state.port) this.disconnect(); });
                this.ui.clearTermBtn.addEventListener('click', () => this.term.clear());

                this.ui.cmdBtns.forEach(b => b.addEventListener('click', () => this.sendCommand(b.dataset.cmd)));

                this.ui.rootLoginBtn.addEventListener('click', () => this.sendCommand('root', false));
                
                this.ui.ifaceUpBtn.addEventListener('click', () => { const iface = this.ui.netIfaceInput.value.trim(); if(iface) this.sendCommand(`ip link set ${iface} up`); });
                this.ui.ifaceDownBtn.addEventListener('click', () => { const iface = this.ui.netIfaceInput.value.trim(); if(iface) this.sendCommand(`ip link set ${iface} down`); });
                this.ui.setIpBtn.addEventListener('click', () => { const iface = this.ui.netIfaceInput.value.trim(); const ip = this.ui.ipAddressInput.value.trim(); if(iface && ip) this.sendCommand(`ip addr add ${ip} dev ${iface}`); });
                
                this.ui.runEthtoolBtn.addEventListener('click', () => { const param = this.ui.ethtoolParamSelect.value; const iface = this.ui.netIfaceInput.value.trim(); if(iface) this.sendCommand(`ethtool ${param} ${iface}`); });
                this.ui.runTcpdumpBtn.addEventListener('click', () => { const opts = this.ui.tcpdumpInput.value.trim(); if(opts) this.sendCommand(`tcpdump ${opts}`); });
                this.ui.runPtp4lBtn.addEventListener('click', () => this.sendCommand(`ptp4l -2 -H -m -s -i end0`));
                this.ui.runMqprioBtn.addEventListener('click', () => this.sendCommand(`tc qdisc add dev end0 root handle 1: mqprio hw 0 num_tc 5 map 1 1 2 3 4 queues 1@0 1@1 1@2 1@3 1@4`));
                this.ui.runTaprioBtn.addEventListener('click', () => this.sendCommand(`tc qdisc add dev end0 root taprio num_tc 5 map 0 1 2 3 4 queues 1@0 1@1 1@2 1@3 1@4 base-time 0 sched-entry S 10 50000 sched-entry S 0f 450000 sched-entry S 1f 96 flags 0x2`));

                this.ui.setCan0Btn.addEventListener('click', () => { const br = this.ui.canBitrateInput.value.trim(); if(br) this.sendCommand(`ip link set can0 type can bitrate ${br} && ip link set can0 up`); });
                this.ui.setCan1Btn.addEventListener('click', () => { const br = this.ui.canBitrateInput.value.trim(); if(br) this.sendCommand(`ip link set can1 type can bitrate ${br} && ip link set can1 up`); });
                this.ui.sendCanBtn.addEventListener('click', () => { const content = this.ui.cansendInput.value.trim(); if(content) this.sendCommand(`cansend ${content}`); });
                
                this.ui.downloadFileBtn.addEventListener('click', () => {
                    const path = this.ui.filePathInput.value.trim();
                    if (!path) {
                        this.term.writeln('\r\n\x1b[33m[SYSTEM] Please enter a file path to download.\x1b[0m');
                        return;
                    }
                    this.state.fileDownloadInProgress = true;
                    this.state.fileDownloadBuffer = '';
                    this.term.writeln(`\r\n\x1b[33m[SYSTEM] Requesting file: ${path}. Please wait...\x1b[0m`);
                    this.sendCommand(`cat ${path} | base64 && echo "DOWNLOAD_END"`, false);
                });

                this.ui.rebootBtn.addEventListener('click', () => { if(confirm('REBOOT the device?')) this.sendCommand('reboot'); });
                this.ui.poweroffBtn.addEventListener('click', () => { if(confirm('POWER OFF the device?')) this.sendCommand('poweroff'); });
            }
        };
    
        App.init();
    });
</script>
</body>
</html>
