<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>S32G Web Control Center - Professional Edition</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

<style>
:root {
    --bg-base: #1e1e1e; --bg-pane: #252526; --bg-element: #3c3c3c;
    --border-color: #4a4a4a; --text-primary: #d4d4d4; --text-secondary: #cccccc;
    --nxp-blue: #0e639c; --nxp-blue-hover: #1579b9;
    --accent-green: #38a169; --accent-yellow: #d19a66; --accent-red: #e06c75;
}

html, body {
    height: 100%; margin: 0; padding: 0; background-color: var(--bg-base); color: var(--text-primary);
    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, "Helvetica Neue", Arial, sans-serif; overflow: hidden;
}

#page-container { display: flex; height: 100%; }
#terminal-pane { flex: 1.2; display: flex; flex-direction: column; min-width: 0; }
#gui-pane { flex: 1; background-color: var(--bg-pane); border-left: 1px solid var(--border-color); overflow-y: auto; padding-bottom: 20px; }

.pane-header, #controls {
    padding: 10px 20px; background-color: #333; flex-shrink: 0;
    border-bottom: 1px solid var(--border-color);
    display: flex; align-items: center; gap: 10px;
}
.pane-header { justify-content: space-between; font-size: 16px; font-weight: 600; color: white; }

#terminal-container { flex-grow: 1; padding: 10px; overflow: hidden; }

button, select, input {
    background-color: var(--bg-element); color: var(--text-primary); border: 1px solid var(--border-color);
    padding: 8px 12px; font-size: 14px; cursor: pointer; border-radius: 6px; transition: all 0.2s;
    box-sizing: border-box; display: flex; align-items: center; gap: 8px;
}
button:hover:not(:disabled) { background-color: var(--nxp-blue); border-color: var(--nxp-blue-hover); }
button:disabled { background-color: #555; color: #999; cursor: not-allowed; }
select, input { width: 100%; }

.gui-section { margin: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-base); overflow: hidden; }
.gui-section summary {
    list-style: none; display: flex; align-items: center; gap: 8px; font-size: 16px; font-weight: 600;
    padding: 12px 15px; background-color: #2a2d2e; cursor: pointer; color: #569cd6;
    border-bottom: 1px solid var(--border-color);
}
.gui-section > div { padding: 15px; }
.button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
.input-group { display: flex; gap: 10px; margin-top: 12px; }
.input-group input { flex-grow: 1; }
.input-group button { flex-shrink: 0; width: auto; justify-content: center; }

#connectBtn { background-color: var(--accent-green); }
#disconnectBtn { background-color: var(--accent-red); }

@media (max-width: 1000px) {
    #gui-pane { display: none; }
    #terminal-pane { flex: 1; }
}
</style>
</head>
<body>
  <div id="page-container">
    <div id="terminal-pane">
        <div id="controls">
            <button id="connectBtn"><i data-lucide="zap"></i>Connect</button>
            <button id="disconnectBtn" disabled><i data-lucide="zap-off"></i>Disconnect</button>
            <select id="baudRateSelect" style="width:auto;">
                <option value="115200" selected>115200</option><option value="57600">57600</option><option value="9600">9600</option>
            </select>
            <button id="clearTermBtn" style="margin-left: auto;"><i data-lucide="trash-2"></i>Clear</button>
        </div>
        <div id="terminal-container"></div>
    </div>
    
    <div id="gui-pane">
        <div class="pane-header">S32G Control Center</div>
        
        <details class="gui-section" open><summary><i data-lucide="log-in"></i>Quick Start</summary><div>
            <div class="button-grid">
                <button id="rootLoginBtn"><i data-lucide="user-cog"></i>Login as root</button>
            </div>
        </div></details>
        
        <details class="gui-section" open><summary><i data-lucide="network"></i>Networking & ethtool</summary><div>
            <div class="button-grid">
                <button class="cmd-btn" data-cmd="ip -c a"><i data-lucide="network"></i>IP Addresses</button>
                <button class="cmd-btn" data-cmd="ip -s link"><i data-lucide="bar-chart-2"></i>Link Stats</button>
            </div>
             <div class="input-group">
                <input id="netIfaceInput" type="text" value="end0" placeholder="Interface">
                <button id="ifaceUpBtn">Link UP</button>
                <button id="ifaceDownBtn">Link DOWN</button>
            </div>
             <div class="input-group">
                <input id="ipAddressInput" type="text" placeholder="e.g., 192.168.1.10/24">
                <button id="setIpBtn">Set IP</button>
            </div>
             <div class="input-group">
                <select id="ethtoolParamSelect">
                    <option value="-T">Timestamping Caps (-T)</option>
                    <option value="-S">Statistics (-S)</option>
                </select>
                <button id="runEthtoolBtn" style="width: auto;">Run Ethtool</button>
            </div>
        </div></details>

        <details class="gui-section" open><summary><i data-lucide="timer"></i>Time-Sensitive Networking (TSN)</summary><div>
            <div class="button-grid">
                <button id="runPtp4lBtn">PTP4L Sync (end0)</button>
                <button id="runMqprioBtn">MQPRIO Example (end0)</button>
                <button id="runTaprioBtn">TAPRIO Example (end0)</button>
            </div>
        </div></details>
        
        <details class="gui-section" open><summary><i data-lucide="bus-front"></i>CAN Bus</summary><div>
            <div class="button-grid">
                <button class="cmd-btn" data-cmd="ip -s link show can0">CAN0 Stats</button>
                <button class="cmd-btn" data-cmd="ip -s link show can1">CAN1 Stats</button>
            </div>
            <div class="input-group">
                <input id="canBitrateInput" type="text" value="500000" placeholder="Bitrate">
                <button id="setCan0Btn">Setup CAN0</button>
                <button id="setCan1Btn">Setup CAN1</button>
            </div>
        </div></details>

        <details class="gui-section" open><summary><i data-lucide="cpu"></i>System & Process</summary><div>
             <div class="button-grid">
                <button class="cmd-btn" data-cmd="ps aux"><i data-lucide="list-ordered"></i>Processes</button>
                <button class="cmd-btn" data-cmd="top -b -n 1"><i data-lucide="activity"></i>Top</button>
                <button class="cmd-btn" data-cmd="free -h"><i data-lucide="memory-stick"></i>Memory</button>
                <button class="cmd-btn" data-cmd="dmesg | tail -n 50"><i data-lucide="notebook-text"></i>dmesg</button>
                <button class="cmd-btn" data-cmd="df -h"><i data-lucide="hard-drive"></i>Disk Usage</button>
                <button class="cmd-btn" data-cmd="ls -lha /"><i data-lucide="folder-root"></i>List Root Dir</button>
            </div>
        </div></details>
        
        <details class="gui-section" open><summary><i data-lucide="power-circle"></i>System Control</summary><div>
            <div class="button-grid">
                <button id="rebootBtn" style="background:var(--accent-yellow);"><i data-lucide="refresh-cw"></i>Reboot</button>
                <button id="poweroffBtn" style="background:var(--accent-red);"><i data-lucide="power-off"></i>Power Off</button>
            </div>
        </div></details>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const App = {
        state: { port: null, isReading: false, onDataDisposable: null },
        ui: {},
        term: new Terminal({
            cursorBlink: true, fontFamily: 'Consolas, "Courier New", monospace', fontSize: 14,
            theme: { background: '#1e1e1e', foreground: '#d4d4d4', cursor: '#d4d4d4', selectionBackground: '#555' }
        }),
        fitAddon: new FitAddon.FitAddon(),

        init() {
            if (!navigator.serial) {
                alert("Web Serial API not supported. Please use a modern browser like Chrome or Edge.");
                return;
            }
            this.cacheUI();
            this.term.loadAddon(this.fitAddon);
            this.term.open(this.ui.terminalContainer);
            this.fitAddon.fit();
            new ResizeObserver(() => this.fitAddon.fit()).observe(this.ui.terminalContainer);
            this.setGuiEnabled(false);
            this.bindEvents();
            lucide.createIcons();
        },
        
        cacheUI() {
            const ids = ['connectBtn', 'disconnectBtn', 'baudRateSelect', 'terminalContainer', 'clearTermBtn', 'rootLoginBtn', 'rebootBtn', 'poweroffBtn', 'netIfaceInput', 'ifaceUpBtn', 'ifaceDownBtn', 'ipAddressInput', 'setIpBtn', 'ethtoolParamSelect', 'runEthtoolBtn', 'runPtp4lBtn', 'runMqprioBtn', 'runTaprioBtn', 'canBitrateInput', 'setCan0Btn', 'setCan1Btn'];
            ids.forEach(id => this.ui[id] = document.getElementById(id));
            this.ui.guiControls = document.querySelectorAll('#gui-pane button, #gui-pane input, #gui-pane select');
            this.ui.cmdBtns = document.querySelectorAll('.cmd-btn');
        },

        setGuiEnabled(enabled) {
            this.ui.guiControls.forEach(c => c.disabled = !enabled);
            this.ui.connectBtn.disabled = enabled;
            this.ui.disconnectBtn.disabled = !enabled;
            this.ui.baudRateSelect.disabled = enabled;
        },

        async sendSerial(data) {
            if (!this.state.port?.writable) return;
            try {
                const writer = this.state.port.writable.getWriter();
                await writer.write(new TextEncoder().encode(data));
                writer.releaseLock();
            } catch (e) { this.term.writeln(`\r\n\x1b[31m[ERROR] Write failed: ${e.message}\x1b[0m`); }
        },

        async sendCommand(cmd, showInTerm = true) {
            if (this.state.port && cmd) {
                this.term.focus();
                if(showInTerm) this.term.writeln(`\x1b[36m$ ${cmd}\x1b[0m`);
                await this.sendSerial(cmd + '\r');
            }
        },
        
        async connect() {
            try {
                this.state.port = await navigator.serial.requestPort();
                await this.state.port.open({ baudRate: parseInt(this.ui.baudRateSelect.value, 10) });
                this.setGuiEnabled(true);
                this.state.isReading = true;
                this.readLoop();
                this.term.writeln('\x1b[32m[SYSTEM] Connected to Serial Port.\x1b[0m');
                this.term.focus();
                this.state.onDataDisposable = this.term.onData(data => this.sendSerial(data));
            } catch (error) { this.term.writeln(`\r\n\x1b[31m[ERROR] ${error.message}\x1b[0m`); }
        },
        
        async disconnect() {
            const portToClose = this.state.port; if (!portToClose) return;
            this.state.isReading = false;
            if (this.state.onDataDisposable) { this.state.onDataDisposable.dispose(); this.state.onDataDisposable = null; }
            if (portToClose.readable) {
                try {
                    const reader = portToClose.readable.getReader();
                    await reader.cancel(); 
                    reader.releaseLock();
                } catch(e) {}
            }
            try { await portToClose.close(); } catch(e) {}
            if (this.state.port === portToClose) {
                this.state.port = null; this.setGuiEnabled(false);
                this.term.writeln('\r\n\x1b[33m[SYSTEM] Disconnected.\x1b[0m');
            }
        },
        
        async readLoop() {
            const textDecoder = new TextDecoderStream();
            const readableStreamClosed = this.state.port.readable.pipeTo(textDecoder.writable);
            const reader = textDecoder.readable.getReader();
            try {
                while (this.state.isReading) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    this.term.write(value);
                }
            } catch (error) {
                if (this.state.isReading) this.term.writeln(`\r\n\x1b[31m[ERROR] Read loop failed: ${error.message}\x1b[0m`);
            } finally { 
                reader.releaseLock(); 
                await readableStreamClosed.catch(()=>{}); 
                if(this.state.port) this.disconnect(); 
            }
        },

        bindEvents() {
            this.ui.connectBtn.addEventListener('click', () => this.connect());
            this.ui.disconnectBtn.addEventListener('click', () => this.disconnect());
            navigator.serial?.addEventListener('disconnect', (e) => { if (e.target === this.state.port) this.disconnect(); });
            this.ui.clearTermBtn.addEventListener('click', () => this.term.clear());

            this.ui.cmdBtns.forEach(b => b.addEventListener('click', () => this.sendCommand(b.dataset.cmd)));

            this.ui.rootLoginBtn.addEventListener('click', () => this.sendCommand('root', false));
            
            this.ui.ifaceUpBtn.addEventListener('click', () => { const iface = this.ui.netIfaceInput.value.trim(); if(iface) this.sendCommand(`ip link set ${iface} up`); });
            this.ui.ifaceDownBtn.addEventListener('click', () => { const iface = this.ui.netIfaceInput.value.trim(); if(iface) this.sendCommand(`ip link set ${iface} down`); });
            this.ui.setIpBtn.addEventListener('click', () => { const iface = this.ui.netIfaceInput.value.trim(); const ip = this.ui.ipAddressInput.value.trim(); if(iface && ip) this.sendCommand(`ip addr add ${ip} dev ${iface}`); });
            
            this.ui.runEthtoolBtn.addEventListener('click', () => { const param = this.ui.ethtoolParamSelect.value; const iface = this.ui.netIfaceInput.value.trim(); if(iface) this.sendCommand(`ethtool ${param} ${iface}`); });
            this.ui.runPtp4lBtn.addEventListener('click', () => this.sendCommand(`ptp4l -2 -H -m -s -i end0`));
            this.ui.runMqprioBtn.addEventListener('click', () => this.sendCommand(`tc qdisc add dev end0 root handle 1: mqprio hw 0 num_tc 5 map 1 1 2 3 4 queues 1@0 1@1 1@2 1@3 1@4`));
            this.ui.runTaprioBtn.addEventListener('click', () => this.sendCommand(`tc qdisc add dev end0 root taprio num_tc 5 map 0 1 2 3 4 queues 1@0 1@1 1@2 1@3 1@4 base-time 0 sched-entry S 10 50000 sched-entry S 0f 450000 sched-entry S 1f 96 flags 0x2`));

            this.ui.setCan0Btn.addEventListener('click', () => { const br = this.ui.canBitrateInput.value.trim(); if(br) this.sendCommand(`ip link set can0 type can bitrate ${br} && ip link set can0 up`); });
            this.ui.setCan1Btn.addEventListener('click', () => { const br = this.ui.canBitrateInput.value.trim(); if(br) this.sendCommand(`ip link set can1 type can bitrate ${br} && ip link set can1 up`); });
            
            this.ui.rebootBtn.addEventListener('click', () => { if(confirm('REBOOT the device?')) this.sendCommand('reboot'); });
            this.ui.poweroffBtn.addEventListener('click', () => { if(confirm('POWER OFF the device?')) this.sendCommand('poweroff'); });
        }
    };
    
    App.init();
});
</script>
</body>
</html>
