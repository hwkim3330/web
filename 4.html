<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Microchip Universal Web Controller (mup1ct/cc on Web)</title>
    <script src="https://cdn.jsdelivr.net/npm/cbor-x@1.5.8/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
    <style>
        :root {
            --bg-color: #f4f7fa;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --border-color: #e2e8f0;
            --pane-bg: rgba(255, 255, 255, 0.85);
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --accent-blue: #2563eb;
            --accent-green: #059669;
            --accent-red: #dc2626;
            --accent-orange: #f97316;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        html, body {
            height: 100%; margin: 0; padding: 0; background-color: var(--bg-color);
            color: var(--text-primary); font-family: var(--font-sans); overflow: hidden;
        }
        #app-container { display: flex; height: 100%; gap: 10px; padding: 10px; }
        .pane { background-color: var(--pane-bg); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; }
        #left-pane { flex: 1; }
        #right-pane { flex: 1.5; }
        .pane-header { padding: 12px 20px; border-bottom: 1px solid var(--border-color); font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 10px; user-select: none;}
        .pane-content { padding: 20px; overflow-y: auto; }
        #controls { padding: 12px; border-bottom: 1px solid var(--border-color); display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        button, select, input { font-family: var(--font-sans); font-size: 14px; border-radius: 8px; border: 1px solid var(--border-color); padding: 8px 12px; }
        button { background-color: var(--accent-blue); color: white; border: none; cursor: pointer; transition: all 0.2s ease; font-weight: 500; }
        button:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(1.1); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #terminal-container { flex-grow: 1; padding: 10px; }
        .tab-buttons { display: flex; border-bottom: 1px solid var(--border-color); }
        .tab-button { padding: 10px 15px; cursor: pointer; background-color: transparent; border: none; border-bottom: 3px solid transparent; font-weight: 500; color: var(--text-secondary); }
        .tab-button.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; }
        #cbor-output { background-color: #f8f9fa; border: 1px solid var(--border-color); padding: 10px; border-radius: 6px; font-family: monospace; word-wrap: break-word; }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="left-pane" class="pane">
            <div class="pane-header">‚öôÔ∏è Controller</div>
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="main">Main Control</button>
                <button class="tab-button" data-tab="advanced">Advanced CoAP</button>
            </div>
            <div class="pane-content">
                <div id="main-tab" class="tab-content active">
                    <div class="form-group">
                        <button id="getFullConfigBtn" style="width:100%; background-color: var(--accent-green);">üì• Get Full Config (mup1cc get)</button>
                    </div>
                    <hr style="border:none; border-top:1px solid var(--border-color); margin: 20px 0;">
                    <h4>iPatch Editor (mup1cc ipatch)</h4>
                    <div class="form-group">
                        <label for="ipatch-sid">Target SID (number):</label>
                        <input type="number" id="ipatch-sid" placeholder="e.g., 7002">
                    </div>
                    <div class="form-group">
                        <label for="ipatch-key">Instance Key (string):</label>
                        <input type="text" id="ipatch-key" placeholder="e.g., 2 (for Port 2)">
                    </div>
                    <div class="form-group">
                        <label for="ipatch-value">Value (JSON format):</label>
                        <input type="text" id="ipatch-value" placeholder='e.g., false or "10.000"'>
                    </div>
                    <button id="sendIPatchBtn" style="width:100%;">üöÄ Send iPatch Request</button>
                </div>
                <div id="advanced-tab" class="tab-content">
                    <h4>Low-level CoAP Tool (mup1ct)</h4>
                     <div class="form-group">
                        <label for="coap-method">Method:</label>
                        <select id="coap-method">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="coap-path">URI-Path:</label>
                        <input type="text" id="coap-path" value="c">
                    </div>
                    <div class="form-group">
                        <label for="coap-payload">Payload (JSON):</label>
                        <textarea id="coap-payload" rows="3" style="width:100%; font-family:monospace;"></textarea>
                    </div>
                    <button id="sendCoapBtn" style="width:100%;">üöÄ Send Raw CoAP Request</button>
                </div>
            </div>
             <div style="padding: 20px; border-top: 1px solid var(--border-color);">
                <h4>Live CBOR Preview</h4>
                <pre id="cbor-output">Input values to see CBOR output...</pre>
            </div>
        </div>
        <div id="right-pane" class="pane">
            <div class="pane-header">üñ•Ô∏è Terminal & Logs</div>
            <div id="controls">
                <button id="connectBtn" style="background-color:var(--accent-green)">üîå Connect</button>
                <button id="disconnectBtn" disabled>‚ùå Disconnect</button>
                <button id="pingBtn" style="background-color: var(--accent-orange);">üèì Ping</button>
                <button id="listenBtn">üëÇ Start Listening</button>
                <button id="clearLogBtn" style="margin-left:auto; background-color: #fff; color: var(--text-primary);">üßπ Clear Log</button>
            </div>
            <div id="terminal-container"></div>
        </div>
    </div>

<script>
// --- Constants from mup1ct.rb ---
const COAP = { GET: 1, POST: 2, PUT: 3, DEL: 4, FETCH: 5, IPATCH: 7 };
const COAP_TYPE = { CON: 0, NON: 1, ACK: 2, RST: 3 };
const COAP_OPTION = { URI_PATH: 11, CONTENT_FORMAT: 12, ACCEPT: 17 };
const COAP_FORMAT = { CBOR: 60, YANG_INSTANCES_CBOR: 142 };
const MUP1_SYM = { SOF: 0x3e, EOF: 0x3c, ESC: 0x5c };

class ProtocolStack {
    // --- CoAP Frame Logic (from CoapFrame class) ---
    static buildCoapFrame({ type, code, msgId, path, payload, contentType, accept }) {
        const header = new Uint8Array(4);
        const view = new DataView(header.buffer);
        view.setUint8(0, (1 << 6) | (type << 4) | 0); // Ver=1, TKL=0
        view.setUint8(1, code);
        view.setUint16(2, msgId, false); // Big Endian

        let options = [];
        let lastOptNum = 0;

        // URI-Path Option
        if (path) {
            const delta = COAP_OPTION.URI_PATH - lastOptNum;
            const len = path.length;
            options.push((delta << 4) | len);
            for (let i = 0; i < len; i++) options.push(path.charCodeAt(i));
            lastOptNum = COAP_OPTION.URI_PATH;
        }

        // Content-Format Option
        if (contentType !== undefined) {
             const delta = COAP_OPTION.CONTENT_FORMAT - lastOptNum;
             const valBytes = this.uintToBytes(contentType);
             options.push((delta << 4) | valBytes.length, ...valBytes);
             lastOptNum = COAP_OPTION.CONTENT_FORMAT;
        }
        
        const frameParts = [header, new Uint8Array(options)];
        if (payload && payload.length > 0) {
            frameParts.push(new Uint8Array([0xFF]), payload);
        }
        
        return this.concatBuffers(frameParts);
    }
    
    // --- MUP1 Frame Logic (from MUP1 class) ---
    static buildMup1Frame(typeChar, data) {
        const type = typeChar.charCodeAt(0);
        
        const unescapedForChecksum = new Uint8Array(2 + data.length + (data.length % 2 === 0 ? 2 : 1));
        unescapedForChecksum[0] = MUP1_SYM.SOF;
        unescapedForChecksum[1] = type;
        unescapedForChecksum.set(data, 2);
        unescapedForChecksum[2 + data.length] = MUP1_SYM.EOF;
        if (data.length % 2 === 0) unescapedForChecksum[3 + data.length] = MUP1_SYM.EOF;
        
        const checksum = this.calculateMup1Checksum(unescapedForChecksum);
        const escapedData = this.escapeMup1Data(data);
        
        const frameParts = [
            new Uint8Array([MUP1_SYM.SOF, type]),
            escapedData,
            new Uint8Array([MUP1_SYM.EOF]),
            ...(data.length % 2 === 0 ? [new Uint8Array([MUP1_SYM.EOF])] : []),
            checksum
        ];
        
        return this.concatBuffers(frameParts);
    }

    static escapeMup1Data(data) {
        const escaped = [];
        const escapeMap = { 0x3e: 0x3e, 0x3c: 0x3c, 0x5c: 0x5c, 0x00: 0x30, 0xff: 0x46 };
        for (const byte of data) {
            if (escapeMap[byte] !== undefined) {
                escaped.push(MUP1_SYM.ESC);
                escaped.push(escapeMap[byte]);
            } else {
                escaped.push(byte);
            }
        }
        return new Uint8Array(escaped);
    }

    static calculateMup1Checksum(data) {
        let sum = 0;
        const view = new DataView(data.buffer);
        for (let i = 0; i < Math.floor(data.length / 2); i++) {
            sum += view.getUint16(i * 2, false);
        }
        if (data.length % 2 !== 0) sum += view.getUint8(data.length - 1) << 8;
        
        sum = (sum >> 16) + (sum & 0xffff);
        sum += (sum >> 16);
        sum = (~sum) & 0xffff;
        
        return new TextEncoder().encode(sum.toString(16).padStart(4, '0'));
    }

    // --- Utility functions ---
    static uintToBytes(num) {
        if (num === 0) return [];
        if (num < 256) return [num];
        const bytes = [];
        while (num > 0) {
            bytes.unshift(num & 0xFF);
            num = num >> 8;
        }
        return bytes;
    }
    static concatBuffers(bufferArray) {
        const totalLength = bufferArray.reduce((acc, val) => acc + val.length, 0);
        const result = new Uint8Array(totalLength);
        let offset = 0;
        for(const buffer of bufferArray) {
            result.set(buffer, offset);
            offset += buffer.length;
        }
        return result;
    }
}

class WebController {
    constructor() {
        this.term = new Terminal({ theme: { background: 'rgba(255,255,255,0.1)', foreground: '#1f2937' }, fontSize: 13, cursorBlink: true });
        this.port = null;
        this.reader = null;
        this.isListening = false;
        this.msgId = Math.floor(Math.random() * 65535);
        this.init();
    }
    
    init() {
        this.term.open(document.getElementById('terminal-container'));
        this.bindEvents();
        this.updateCborPreview();
    }
    
    bindEvents() {
        // Connection
        document.getElementById('connectBtn').addEventListener('click', () => this.connect());
        document.getElementById('disconnectBtn').addEventListener('click', () => this.disconnect());
        // Actions
        document.getElementById('pingBtn').addEventListener('click', () => this.sendPing());
        document.getElementById('listenBtn').addEventListener('click', () => this.toggleListen());
        document.getElementById('clearLogBtn').addEventListener('click', () => this.term.clear());
        document.getElementById('getFullConfigBtn').addEventListener('click', () => this.getFullConfig());
        document.getElementById('sendIPatchBtn').addEventListener('click', () => this.sendIPatch());
        document.getElementById('sendCoapBtn').addEventListener('click', () => this.sendRawCoap());
        // Tabs
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button, .tab-content').forEach(el => el.classList.remove('active'));
                button.classList.add('active');
                document.getElementById(button.dataset.tab + '-tab').classList.add('active');
            });
        });
        // Live CBOR Preview
        document.querySelectorAll('#main-tab input, #advanced-tab input, #advanced-tab select, #advanced-tab textarea')
            .forEach(el => el.addEventListener('input', () => this.updateCborPreview()));
    }

    log(type, message) {
        const colors = { info: '\x1b[34m', success: '\x1b[32m', warn: '\x1b[33m', error: '\x1b[31m', tx: '\x1b[35m', rx: '\x1b[36m' };
        this.term.writeln(`${colors[type] || ''}[${type.toUpperCase()}] ${message}\x1b[0m`);
    }

    async connect() {
        try {
            this.port = await navigator.serial.requestPort();
            await this.port.open({ baudRate: 115200 });
            this.log('success', 'Connected via Web Serial.');
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;
            this.listenLoop();
        } catch (e) { this.log('error', e.message); }
    }
    
    async disconnect() {
        this.isListening = false;
        if (this.reader) {
            await this.reader.cancel();
            this.reader = null;
        }
        if (this.port) {
            await this.port.close();
            this.port = null;
        }
        this.log('warn', 'Disconnected.');
        document.getElementById('connectBtn').disabled = false;
        document.getElementById('disconnectBtn').disabled = true;
    }
    
    async listenLoop() {
        while (this.port?.readable) {
            this.reader = this.port.readable.getReader();
            try {
                while (true) {
                    const { value, done } = await this.reader.read();
                    if (done) break;
                    if (this.isListening) {
                         this.log('rx', new TextDecoder().decode(value));
                    }
                }
            } catch (error) {
                // Ignore disconnect errors
            } finally {
                this.reader.releaseLock();
            }
        }
    }
    
    toggleListen() {
        this.isListening = !this.isListening;
        document.getElementById('listenBtn').textContent = this.isListening ? 'üõë Stop Listening' : 'üëÇ Start Listening';
        this.log('info', `Listening mode ${this.isListening ? 'enabled' : 'disabled'}.`);
    }

    async sendFrame(frame) {
        if (!this.port) { this.log('error', 'Not connected.'); return; }
        const writer = this.port.writable.getWriter();
        await writer.write(frame);
        writer.releaseLock();
        this.log('tx', `Sent ${frame.length} bytes: ${Array.from(frame).map(b => b.toString(16).padStart(2,'0')).join(' ')}`);
    }

    sendPing() {
        const frame = ProtocolStack.buildMup1Frame('p', new Uint8Array(0));
        this.sendFrame(frame);
    }
    
    getFullConfig() {
        const coapFrame = ProtocolStack.buildCoapFrame({
            type: COAP_TYPE.CON,
            code: COAP.GET,
            msgId: this.msgId++,
            path: 'c'
        });
        const mup1Frame = ProtocolStack.buildMup1Frame('c', coapFrame);
        this.sendFrame(mup1Frame);
    }

    sendIPatch() {
        const { payload, error } = this.createIPatchCbor();
        if (error) { this.log('error', error); return; }
        
        const coapFrame = ProtocolStack.buildCoapFrame({
            type: COAP_TYPE.CON,
            code: COAP.IPATCH,
            msgId: this.msgId++,
            path: 'c',
            payload: payload,
            contentType: COAP_FORMAT.YANG_INSTANCES_CBOR
        });
        const mup1Frame = ProtocolStack.buildMup1Frame('c', coapFrame);
        this.sendFrame(mup1Frame);
    }
    
    sendRawCoap() {
        const { payload, error } = this.createRawCoapCbor();
        if (error) { this.log('error', error); return; }
        
        const method = document.getElementById('coap-method').value;
        const path = document.getElementById('coap-path').value;

        const coapFrame = ProtocolStack.buildCoapFrame({
            type: COAP_TYPE.CON,
            code: COAP[method],
            msgId: this.msgId++,
            path: path,
            payload: payload
        });
        const mup1Frame = ProtocolStack.buildMup1Frame('c', coapFrame);
        this.sendFrame(mup1Frame);
    }

    updateCborPreview() {
        const activeTab = document.querySelector('.tab-button.active').dataset.tab;
        let cborPayload, error;
        
        if (activeTab === 'main') {
            ({ payload: cborPayload, error } = this.createIPatchCbor());
        } else {
            ({ payload: cborPayload, error } = this.createRawCoapCbor());
        }

        const outputEl = document.getElementById('cbor-output');
        if (error) {
            outputEl.textContent = `Error: ${error}`;
            outputEl.style.color = 'red';
        } else if (cborPayload) {
            outputEl.textContent = Array.from(cborPayload).map(b => b.toString(16).padStart(2, '0')).join(' ');
            outputEl.style.color = 'black';
        } else {
            outputEl.textContent = 'Input values to see CBOR output...';
        }
    }
    
    createIPatchCbor() {
        try {
            const sid = parseInt(document.getElementById('ipatch-sid').value);
            const key = document.getElementById('ipatch-key').value;
            let value = JSON.parse(document.getElementById('ipatch-value').value || 'null');
            
            if (isNaN(sid) || !key) return { payload: null };

            const keyCbor = cbor.encode(key);
            const valueCbor = cbor.encode(value);
            const entry = new Map([[203, [keyCbor, valueCbor]]]); // 203 = i-patch tag
            const cborMap = new Map([[sid, entry]]);
            return { payload: cbor.encode(cborMap) };
        } catch (e) {
            return { error: `Invalid JSON in Value field: ${e.message}`};
        }
    }

    createRawCoapCbor() {
        try {
            const payloadStr = document.getElementById('coap-payload').value;
            if (!payloadStr.trim()) return { payload: new Uint8Array(0) };
            const payloadObj = JSON.parse(payloadStr);
            return { payload: cbor.encode(payloadObj) };
        } catch(e) {
            return { error: `Invalid JSON in Payload field: ${e.message}`};
        }
    }
}

new WebController();

</script>
</body>
</html>
