<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>S32G Pro Control Center (Glass UI)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <style>
        :root {
            --accent-purple: #a855f7;
            --accent-purple-hover: #9333ea;
            --bg-color-start: #1f005c;
            --bg-color-mid: #6d28d9;
            --bg-color-end: #d946ef;
            --text-color: #f9fafb;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --stop-btn-bg: rgba(239, 68, 68, 0.6);
            --stop-btn-hover-bg: rgba(220, 38, 38, 0.8);
        }

        body, html {
            height: 100%; margin: 0; padding: 0;
            color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 14px; overflow: hidden;
            background: linear-gradient(135deg, var(--bg-color-start) 0%, var(--bg-color-mid) 50%, var(--bg-color-end) 100%);
        }

        /* Layout */
        #page-container { display: flex; height: 100vh; }
        #terminal-pane { flex: 1.5; min-width: 0; display: flex; flex-direction: column; }
        #gui-pane { flex: 1; overflow-y: auto; padding: 12px; backdrop-filter: blur(20px); }

        /* Glass Effect Sections */
        #controls, .gui-section {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Top Controls */
        #controls { padding: 8px 15px; display: flex; gap: 10px; align-items: center; margin: 10px; margin-bottom: 5px; }
        #terminal-container { flex-grow: 1; padding: 10px; background-color: rgba(0,0,0,0.5); border-radius: 12px; margin: 0 10px 10px 10px; }

        /* GUI Panel Styling */
        .gui-section h3 {
            color: var(--text-color); padding: 12px 15px; margin: 0; font-size: 1.1em; font-weight: 600;
            border-bottom: 1px solid var(--glass-border);
        }
        .gui-section .content { padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; }
        .input-group { display: flex; gap: 8px; align-items: center; }

        /* Controls (Buttons, Inputs) */
        button, select, input, textarea {
            width: 100%; background-color: rgba(0,0,0,0.2); color: var(--text-color); border: 1px solid var(--glass-border);
            padding: 9px 12px; border-radius: 8px; font-family: inherit; font-size: 0.9em; box-sizing: border-box; transition: all 0.2s;
        }
        ::placeholder { color: rgba(255,255,255,0.6); }
        button { cursor: pointer; font-weight: 600; }
        button:hover:not(:disabled) { background-color: rgba(0,0,0,0.4); }
        button:disabled { background-color: rgba(0,0,0,0.1); color: rgba(255,255,255,0.4); cursor: not-allowed; }
        label { white-space: nowrap; font-size: 0.9em; font-weight: 500; }
        #controls button, #controls select { width: auto; }
        
        /* Special Buttons */
        .action-btn { background-color: var(--accent-purple); border-color: transparent; }
        .action-btn:hover:not(:disabled) { background-color: var(--accent-purple-hover); }
        .stop-btn { background-color: var(--stop-btn-bg); border-color: transparent; }
        .stop-btn:hover:not(:disabled) { background-color: var(--stop-btn-hover-bg); }
        
        #status { margin-top: 5px; font-size: 0.9em; color: var(--text-color); min-height: 1.2em; text-align: center; }
        
        @media (max-width: 1100px) { #gui-pane { display: none; } #terminal-pane { flex: 1; } }
    </style>
</head>
<body>
<div id="page-container">
    <div id="terminal-pane">
        <div id="controls">
            <button id="connectBtn" style="background-color: #28a745; color: white;">üîå Connect</button>
            <button id="disconnectBtn" disabled style="background-color: #6c757d; color: white;">‚ùå Disconnect</button>
            <select id="baudRateSelect"><option value="115200">115200</option><option value="9600">9600</option></select>
            <button id="rootLoginBtn" class="action-btn" disabled>üîë Login as root</button>
            <button id="clearTermBtn" style="margin-left: auto;">üßπ Clear</button>
        </div>
        <div id="terminal-container"></div>
    </div>
    <div id="gui-pane">
        <div class="gui-section"><h3>System & Process</h3><div class="content button-grid"><button class="cmd-btn" data-cmd="ps aux">üìã Processes</button><button class="cmd-btn" data-cmd="top -b -n 1">üîº Top</button><button class="cmd-btn" data-cmd="free -h">üíæ Memory</button><button class="cmd-btn" data-cmd="df -h">üíΩ Disk</button><button class="cmd-btn" data-cmd="dmesg | tail -n 50">üìú dmesg</button></div><div class="content"><div class="input-group"><label>Kill PID:</label><input id="killPidInput" placeholder="PID"><button id="killBtn" class="stop-btn">Kill</button></div></div></div>
        <div class="gui-section"><h3>Network & Routing</h3><div class="content"><div class="button-grid"><button class="cmd-btn" data-cmd="ip -c a">IP Addresses</button><button class="cmd-btn" data-cmd="ifconfig">ifconfig</button><button class="cmd-btn" data-cmd="ip route">Routing Table</button></div><hr style="border-color: var(--glass-border);"><div class="input-group"><input id="setIpIfaceInput" value="end0"><input id="ipAddressInput" placeholder="192.168.1.10/24"><button id="setIpBtn" class="action-btn">Set IP</button></div></div></div>
        <div class="gui-section"><h3>PTP & Ethtool</h3><div class="content"><div class="input-group"><label>Ethtool:</label><input id="ethtoolIfaceInput" type="text" value="end0"><select id="ethtoolParamSelect"><option value="-T">Timestamping</option><option value="-S">Statistics</option><option value="-k">Features</option></select><button id="runEthtoolBtn" class="action-btn">Run</button></div><hr><div class="input-group"><input id="ptp4lIfaceInput" type="text" value="end0"><select id="ptp4lTransportSelect" style="width: auto;"><option value="-2">L2</option><option value="-4">UDPv4</option></select><input id="ptp4lDomainInput" type="number" value="0" style="width: 80px;" title="Domain"><button id="runPtp4lBtn" class="action-btn">‚ñ∂Ô∏è Start PTP</button><button class="cmd-btn stop-btn" data-cmd="killall ptp4l">‚èπÔ∏è Stop</button></div></div></div>
        <div class="gui-section"><h3>Advanced TC (taprio)</h3><div class="content"><div class="input-group"><label>Iface:</label><input id="tcIfaceInput" value="end0"><label>Num TC:</label><input id="tcNumTcInput" type="number" value="5" style="width:80px"></div><textarea id="tcSchedEntryTextarea" rows="3" placeholder="sched-entry S ...">sched-entry S 1e 500000
sched-entry S 01 500000</textarea><div class="button-grid"><button id="runTcBtn" class="action-btn">Apply TC Qdisc</button><button id="deleteTcBtn" class="stop-btn">Delete TC Qdisc</button></div></div></div>
        <div class="gui-section"><h3>Network Capture & Performance</h3><div class="content"><div class="input-group"><label>tcpdump:</label><input id="tcpdumpInput" value="-i end0" placeholder="options"><button id="runTcpdumpBtn" class="action-btn">‚ñ∂Ô∏è Start</button><button class="cmd-btn stop-btn" data-cmd="killall tcpdump">‚èπÔ∏è Stop</button></div><hr><div class="input-group"><label>iperf3 Srv:</label><button class="cmd-btn action-btn" data-cmd="iperf3 -s -D">‚ñ∂Ô∏è Start</button><button class="cmd-btn stop-btn" data-cmd="killall iperf3">‚èπÔ∏è Stop</button></div><hr><div class="input-group"><label>iperf3 Cli:</label><input id="iperfClientInput" value="127.0.0.1" placeholder="<host> [options]"><button id="runIperfClientBtn" class="action-btn">Run Client</button></div></div></div>
        <div class="gui-section"><h3>File Transfer</h3><div class="content"><div class="input-group"><input type="file" id="fileInput"><button id="uploadFileBtn" class="action-btn">‚¨ÜÔ∏è Upload</button></div><div class="input-group"><label>Path:</label><input id="remotePathInput" placeholder="/tmp/uploaded_file"></div><hr><div class="input-group"><input id="downloadPathInput" placeholder="/tmp/capture.pcap"><button id="downloadFileBtn" class="action-btn">‚¨áÔ∏è Download</button></div><div id="status"></div></div></div>
        <div class="gui-section"><h3>System Control</h3><div class="content button-grid"><button id="rebootBtn" style="background-color: #ffc107; color: #212529;">üîÑ Reboot</button><button id="poweroffBtn" class="stop-btn">üîå Power Off</button></div></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const App = {
        state: { port: null, reader: null, writer: null, isReading: false, onDataDisposable: null, fileDownloadInProgress: false, fileDownloadBuffer: '', },
        ui: {},
        term: new Terminal({ cursorBlink: true, fontFamily: 'monospace', fontSize: 14, theme: { background: 'transparent', foreground: '#f9fafb', cursor: '#f9fafb', selectionBackground: 'rgba(168, 85, 247, 0.5)' }, allowTransparency: true }),
        fitAddon: new FitAddon.FitAddon(),

        init() {
            if (!navigator.serial) { alert("Web Serial API is not supported."); return; }
            this.cacheUI(); this.setupTerminal(); this.setGuiEnabled(false); this.bindEvents();
        },
        
        cacheUI() {
            const ids = [
                'connectBtn', 'disconnectBtn', 'baudRateSelect', 'rootLoginBtn', 'clearTermBtn', 'terminal-container',
                'setIpIfaceInput', 'ipAddressInput', 'setIpBtn',
                'ethtoolParamSelect', 'ethtoolIfaceInput', 'runEthtoolBtn',
                'ptp4lIfaceInput', 'ptp4lTransportSelect', 'ptp4lDomainInput', 'runPtp4lBtn',
                'tcIfaceInput', 'tcNumTcInput', 'tcSchedEntryTextarea', 'runTcBtn', 'deleteTcBtn',
                'tcpdumpInput', 'runTcpdumpBtn', 'iperfClientInput', 'runIperfClientBtn',
                'killPidInput', 'killBtn',
                'fileInput', 'remotePathInput', 'uploadFileBtn', 'downloadPathInput', 'downloadFileBtn', 'status',
                'rebootBtn', 'poweroffBtn'
            ];
            ids.forEach(id => { const el = document.getElementById(id); this.ui[id.replace(/-/g, '')] = el; });
            this.ui.cmdBtns = document.querySelectorAll('.cmd-btn');
            this.ui.guiControls = document.querySelectorAll('#gui-pane button, #gui-pane input, #gui-pane select, #gui-pane textarea, #rootLoginBtn');
        },

        setupTerminal() {
            this.term.loadAddon(this.fitAddon);
            this.term.open(this.ui.terminalcontainer);
            this.fitAddon.fit();
            new ResizeObserver(() => this.fitAddon.fit()).observe(this.ui.terminalcontainer);
        },

        setGuiEnabled(enabled) {
            this.ui.guiControls.forEach(c => c.disabled = !enabled);
            this.ui.connectBtn.disabled = enabled;
            this.ui.disconnectBtn.disabled = !enabled;
            this.ui.baudRateSelect.disabled = enabled;
        },

        async sendSerial(data) {
            if (!this.state.port?.writable) return;
            try {
                const writer = this.state.port.writable.getWriter();
                await writer.write(new TextEncoder().encode(data));
                writer.releaseLock();
            } catch (e) { this.term.writeln(`\r\n\x1b[31m[E] Write failed: ${e.message}\x1b[0m`); }
        },

        async sendCommand(cmd, showInTerm = true) {
            if (this.state.port && cmd) {
                this.term.focus();
                if(showInTerm) this.term.writeln(`\x1b[38;2;168;85;247m$ ${cmd}\x1b[0m`);
                await this.sendSerial(cmd + '\r');
            }
        },

        async connect() { /* ... unchanged ... */
            if (this.state.port) return;
            try {
                this.state.port = await navigator.serial.requestPort();
                await this.state.port.open({ baudRate: parseInt(this.ui.baudRateSelect.value, 10) });
                this.setGuiEnabled(true); this.state.isReading = true; this.readLoop();
                this.term.writeln('\x1b[32m[SYSTEM] Connected.\x1b[0m'); this.term.focus();
                this.state.onDataDisposable = this.term.onData(data => { if (!this.state.fileDownloadInProgress) { this.sendSerial(data); } });
            } catch (error) { this.term.writeln(`\r\n\x1b[31m[E] ${error.message}\x1b[0m`); this.state.port = null; }
        },
        async disconnect() { /* ... unchanged ... */
            const portToClose = this.state.port; if (!portToClose) return;
            this.state.isReading = false;
            if (this.state.onDataDisposable) { this.state.onDataDisposable.dispose(); this.state.onDataDisposable = null; }
            if (this.state.reader) { try { await this.state.reader.cancel(); } catch (e) {} }
            try { await portToClose.close(); } catch (e) {}
            if (this.state.port === portToClose) { this.state.port = null; this.state.reader = null; this.setGuiEnabled(false); this.term.writeln('\r\n\x1b[33m[SYSTEM] Disconnected.\x1b[0m'); }
        },
        async readLoop() { /* ... unchanged ... */
            while (this.state.port?.readable && this.state.isReading) {
                const textDecoder = new TextDecoder();
                this.state.reader = this.state.port.readable.getReader();
                try {
                    while (true) {
                        const { value, done } = await this.state.reader.read();
                        if (done) { this.state.reader.releaseLock(); break; }
                        const decodedChunk = textDecoder.decode(value, { stream: true });
                        if (this.state.fileDownloadInProgress) { this.handleFileDownloadChunk(decodedChunk); } else { this.term.write(decodedChunk); }
                    }
                } catch (error) { if (this.state.isReading) { this.term.writeln(`\r\n\x1b[31m[E] Read loop: ${error.message}\x1b[0m`); } }
            }
        },
        handleFileUpload() { /* ... unchanged ... */
            const file = this.ui.fileInput.files[0]; const remotePath = this.ui.remotePathInput.value.trim();
            if (!file || !remotePath) { this.ui.status.textContent = "Select file and enter path."; return; }
            const reader = new FileReader(); this.ui.status.textContent = `Reading ${file.name}...`; this.ui.uploadFileBtn.disabled = true;
            reader.onload = (e) => {
                const base64Content = e.target.result.split(',')[1]; const cmd = `echo '${base64Content}' | base64 -d > ${remotePath}`;
                this.ui.status.textContent = `Uploading...`; this.sendCommand(cmd, false).then(() => { this.ui.status.textContent = 'Upload initiated.'; });
            };
            reader.onloadend = () => { this.ui.uploadFileBtn.disabled = false; }; reader.onerror = (err) => { this.ui.status.textContent = `Error reading file.`; }; reader.readAsDataURL(file);
        },
        handleFileDownload() { /* ... unchanged ... */
            const path = this.ui.downloadPathInput.value.trim(); if (!path) { this.ui.status.textContent = 'Enter a file path.'; return; }
            if (this.state.fileDownloadInProgress) { this.ui.status.textContent = 'Download in progress.'; return; }
            this.state.fileDownloadInProgress = true; this.state.fileDownloadBuffer = ''; this.ui.status.textContent = `Requesting ${path}...`;
            this.sendCommand(`if [ -f "${path}" ]; then cat "${path}" | base64; echo; fi; echo "DOWNLOAD_END"`, false);
        },
        handleFileDownloadChunk(chunk) { /* ... unchanged ... */
            this.state.fileDownloadBuffer += chunk; const endMarker = 'DOWNLOAD_END';
            if (this.state.fileDownloadBuffer.includes(endMarker)) {
                const fileData = this.state.fileDownloadBuffer.substring(0, this.state.fileDownloadBuffer.indexOf(endMarker)).trim();
                this.state.fileDownloadInProgress = false; this.state.fileDownloadBuffer = '';
                if (fileData.length === 0) { this.term.writeln('\r\n\x1b[33m[W] Download failed (file not found or empty).\x1b[0m'); this.ui.status.textContent = 'Download failed.'; return; }
                this.ui.status.textContent = 'Decoding...'; this.saveDownloadedFile(fileData);
            }
        },
        saveDownloadedFile(base64Data) { /* ... unchanged ... */
            try {
                const byteCharacters = atob(base64Data); const byteArray = new Uint8Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) { byteArray[i] = byteCharacters.charCodeAt(i); }
                const blob = new Blob([byteArray]); const link = document.createElement('a');
                link.href = URL.createObjectURL(blob); const filename = this.ui.downloadPathInput.value.split('/').pop() || 'downloaded_file';
                link.download = filename; link.click(); link.remove(); this.ui.status.textContent = `File "${filename}" downloaded.`;
            } catch (e) { this.term.writeln(`\r\n\x1b[31m[E] Decode/save failed: ${e.message}\x1b[0m`); this.ui.status.textContent = 'Error: Failed to decode.'; }
        },

        bindEvents() {
            this.ui.connectBtn.addEventListener('click', () => this.connect());
            this.ui.disconnectBtn.addEventListener('click', () => this.disconnect());
            this.ui.clearTermBtn.addEventListener('click', () => this.term.clear());
            this.ui.rootLoginBtn.addEventListener('click', () => this.sendCommand('root', true));
            this.ui.cmdBtns.forEach(b => b.addEventListener('click', () => this.sendCommand(b.dataset.cmd)));
            
            // --- New & Updated Event Logic ---
            this.ui.setIpBtn.addEventListener('click', () => {
                const iface = this.ui.setIpIfaceInput.value.trim(); const ip = this.ui.ipAddressInput.value.trim();
                if(iface && ip) this.sendCommand(`ip addr add ${ip} dev ${iface}`);
            });
            this.ui.runEthtoolBtn.addEventListener('click', () => { const p = this.ui.ethtoolParamSelect.value; const i = this.ui.ethtoolIfaceInput.value.trim(); if(i) this.sendCommand(`ethtool ${p} ${i}`); });
            this.ui.runPtp4lBtn.addEventListener('click', () => {
                const i = this.ui.ptp4lIfaceInput.value.trim(); const t = this.ui.ptp4lTransportSelect.value; const d = this.ui.ptp4lDomainInput.value.trim();
                if(i) this.sendCommand(`ptp4l -i ${i} ${t} -d ${d} -m &`);
            });
            this.ui.runTcBtn.addEventListener('click', () => {
                const iface = this.ui.tcIfaceInput.value.trim(); const num_tc = this.ui.tcNumTcInput.value.trim();
                const sched_entries = this.ui.tcSchedEntryTextarea.value.trim().split('\n').map(line => line.trim()).filter(line => line.length > 0).join(' ');
                if (!iface || !num_tc || !sched_entries) { this.ui.status.textContent = "TC fields cannot be empty."; return; }

                // Build map and queues, respecting "no queue 0" rule
                let map_str = Array.from({length: parseInt(num_tc)}, (_, i) => i).join(' ');
                let queues_str = Array.from({length: parseInt(num_tc) - 1}, (_, i) => `1@${i + 1}`).join(' ');

                const cmd = `tc qdisc replace dev ${iface} parent root handle 100 taprio num_tc ${num_tc} map ${map_str} queues ${queues_str} base-time 0 ${sched_entries} flags 0x2`;
                this.sendCommand(cmd);
            });
            this.ui.deleteTcBtn.addEventListener('click', () => {
                const iface = this.ui.tcIfaceInput.value.trim();
                if (iface) this.sendCommand(`tc qdisc del dev ${iface} root`);
            });

            this.ui.runTcpdumpBtn.addEventListener('click', () => { const o = this.ui.tcpdumpInput.value.trim(); if(o) this.sendCommand(`tcpdump ${o} -w /tmp/capture.pcap &`); });
            this.ui.runIperfClientBtn.addEventListener('click', () => { const o = this.ui.iperfClientInput.value.trim(); if(o) this.sendCommand(`iperf3 -c ${o}`); });
            this.ui.killBtn.addEventListener('click', () => { const p = this.ui.killPidInput.value.trim(); if(p && confirm(`Kill PID ${p}?`)) this.sendCommand(`kill -9 ${p}`); });
            this.ui.uploadFileBtn.addEventListener('click', () => this.handleFileUpload());
            this.ui.downloadFileBtn.addEventListener('click', () => this.handleFileDownload());
            this.ui.rebootBtn.addEventListener('click', () => { if(confirm('REBOOT the device?')) this.sendCommand('reboot'); });
            this.ui.poweroffBtn.addEventListener('click', () => { if(confirm('POWER OFF the device?')) this.sendCommand('poweroff'); });
        }
    };
    App.init();
});
</script>
</body>
</html>
