<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>S32G Functional Web Control Center</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <style>
        /* Light Theme Color Palette */
        :root {
            --bg-main: #f4f4f9;
            --bg-panel: #ffffff;
            --border: #d1d5db;
            --text-main: #212529;
            --text-muted: #6c757d;
            --header-bg: #007bff;
            --header-text: #ffffff;
            --btn-default-bg: #e9ecef;
            --btn-default-text: #212529;
            --btn-default-hover-bg: #d1d5db;
            --btn-stop-bg: #dc3545;
            --btn-stop-hover-bg: #c82333;
            --btn-action-bg: #007bff;
            --btn-action-hover-bg: #0069d9;
        }

        body, html { height: 100%; margin: 0; padding: 0; background-color: var(--bg-main); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; overflow: hidden; }

        /* Layout */
        #page-container { display: flex; height: 100vh; }
        #terminal-pane { flex: 1.5; min-width: 0; display: flex; flex-direction: column; }
        #gui-pane { flex: 1; background-color: var(--bg-panel); border-left: 1px solid var(--border); overflow-y: auto; padding: 12px; box-shadow: -2px 0 5px rgba(0,0,0,0.05); }

        /* Top Controls */
        #controls { padding: 8px 15px; background-color: #ffffff; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid var(--border); }
        #terminal-container { flex-grow: 1; padding: 5px; background-color: #1e1e1e; } /* Keep terminal dark for contrast */

        /* GUI Panel Styling */
        .gui-section { margin-bottom: 15px; border: 1px solid var(--border); border-radius: 6px; background: #fff; }
        .gui-section h3 { background-color: var(--header-bg); color: var(--header-text); padding: 10px 15px; margin: 0; font-size: 1em; font-weight: 600; border-radius: 5px 5px 0 0; border-bottom: 1px solid var(--border); }
        .gui-section .content { padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; }
        .input-group { display: flex; gap: 8px; align-items: center; }

        /* Controls (Buttons, Inputs) */
        button, select, input { width: 100%; background-color: var(--btn-default-bg); color: var(--btn-default-text); border: 1px solid var(--border); padding: 8px 12px; border-radius: 4px; font-family: inherit; font-size: 0.9em; box-sizing: border-box; transition: background-color 0.2s; }
        button { cursor: pointer; text-align: center; font-weight: 500; }
        button:hover:not(:disabled) { background-color: var(--btn-default-hover-bg); }
        button:disabled { background-color: #f8f9fa; color: #adb5bd; cursor: not-allowed; }
        input { background-color: #fff; }
        label { white-space: nowrap; font-size: 0.9em; color: var(--text-muted); }
        #controls button, #controls select { width: auto; }
        
        /* Special Buttons */
        .stop-btn { background-color: var(--btn-stop-bg); color: white; }
        .stop-btn:hover:not(:disabled) { background-color: var(--btn-stop-hover-bg); }
        .action-btn { background-color: var(--btn-action-bg); color: white; }
        .action-btn:hover:not(:disabled) { background-color: var(--btn-action-hover-bg); }
        
        #status { margin-top: 5px; font-size: 0.9em; color: var(--btn-action-bg); min-height: 1.2em; }
        
        /* Responsive: Hide GUI panel on narrow screens */
        @media (max-width: 1100px) {
            #gui-pane { display: none; }
            #terminal-pane { flex: 1; }
        }
    </style>
</head>
<body>
<div id="page-container">
    <div id="terminal-pane">
        <div id="controls">
            <button id="connectBtn" style="background-color: #28a745; color: white;">üîå Connect</button>
            <button id="disconnectBtn" disabled style="background-color: #6c757d; color: white;">‚ùå Disconnect</button>
            <select id="baudRateSelect"><option value="115200">115200</option><option value="9600">9600</option></select>
            <button id="rootLoginBtn" class="action-btn" disabled>üîë Login as root</button>
            <button id="clearTermBtn" style="margin-left: auto;">üßπ Clear Terminal</button>
        </div>
        <div id="terminal-container"></div>
    </div>
    <div id="gui-pane">
        <div class="gui-section"><h3>System & Process</h3><div class="content button-grid"><button class="cmd-btn" data-cmd="ps aux">üìã Processes</button><button class="cmd-btn" data-cmd="top -b -n 1">üîº Top</button><button class="cmd-btn" data-cmd="free -h">üíæ Memory</button><button class="cmd-btn" data-cmd="df -h">üíΩ Disk</button><button class="cmd-btn" data-cmd="dmesg | tail -n 50">üìú dmesg</button></div><div class="content"><div class="input-group"><label>Kill PID:</label><input id="killPidInput" placeholder="PID"><button id="killBtn" class="stop-btn">Kill</button></div></div></div>
        <div class="gui-section"><h3>Network Interface & Routing</h3><div class="content button-grid"><button class="cmd-btn" data-cmd="ip -c a">IP Addresses</button><button class="cmd-btn" data-cmd="ifconfig">ifconfig</button><button class="cmd-btn" data-cmd="ip route">Routing Table</button><button class="cmd-btn" data-cmd="brctl show">Show Bridges</button><button class="cmd-btn" data-cmd="iptables -L -n -v">List iptables</button></div></div>
        <div class="gui-section"><h3>TSN & Ethtool</h3><div class="content"><div class="input-group"><label>Ethtool:</label><input id="ethtoolIfaceInput" type="text" value="end0"><select id="ethtoolParamSelect"><option value="-T">Timestamping</option><option value="-S">Statistics</option><option value="-k">Features</option><option value="-i">Driver Info</option></select><button id="runEthtoolBtn" class="action-btn">Run</button></div><hr><div class="input-group"><label>PTP4L:</label><input id="ptp4lIfaceInput" type="text" value="end0"><button id="runPtp4lBtn" class="action-btn">‚ñ∂Ô∏è Start</button><button class="cmd-btn stop-btn" data-cmd="killall ptp4l">‚èπÔ∏è Stop</button></div></div></div>
        <div class="gui-section"><h3>Network Performance & Capture</h3><div class="content"><div class="input-group"><label>tcpdump:</label><input id="tcpdumpInput" value="-i end0" placeholder="options"><button id="runTcpdumpBtn" class="action-btn">‚ñ∂Ô∏è Start</button><button class="cmd-btn stop-btn" data-cmd="killall tcpdump">‚èπÔ∏è Stop</button></div><hr><div class="input-group"><label>iperf3 Srv:</label><button class="cmd-btn action-btn" data-cmd="iperf3 -s -D">‚ñ∂Ô∏è Start</button><button class="cmd-btn stop-btn" data-cmd="killall iperf3">‚èπÔ∏è Stop</button></div><hr><div class="input-group"><label>iperf3 Cli:</label><input id="iperfClientInput" value="127.0.0.1" placeholder="<host> [options]"><button id="runIperfClientBtn" class="action-btn">Run Client</button></div></div></div>
        <div class="gui-section"><h3>CAN Bus</h3><div class="content"><div class="button-grid"><button class="cmd-btn" data-cmd="ip -s link show can0">CAN0 Stats</button><button class="cmd-btn" data-cmd="ip -s link show can1">CAN1 Stats</button></div><hr><div class="input-group"><label>Candump:</label><input id="candumpInput" value="any" placeholder="<iface>"><button id="runCandumpBtn" class="action-btn">‚ñ∂Ô∏è Sniff</button><button class="cmd-btn stop-btn" data-cmd="killall candump">‚èπÔ∏è Stop</button></div><hr><div class="input-group"><label>Cansend:</label><input id="cansendInput" value="can0 123#112233" placeholder="<iface> <id>#<data>"><button id="sendCanBtn" class="action-btn">Send</button></div></div></div>
        <div class="gui-section"><h3>File Transfer</h3><div class="content"><div class="input-group"><label>Upload:</label><input type="file" id="fileInput"><button id="uploadFileBtn" class="action-btn">‚¨ÜÔ∏è Upload</button></div><div class="input-group"><label>Path:</label><input id="remotePathInput" placeholder="/tmp/uploaded_file"></div><hr><div class="input-group"><label>Download:</label><input id="downloadPathInput" placeholder="/tmp/capture.pcap"><button id="downloadFileBtn" class="action-btn">‚¨áÔ∏è Download</button></div><div id="status"></div></div></div>
        <div class="gui-section"><h3>System Control</h3><div class="content button-grid"><button id="rebootBtn" style="background-color: #ffc107; color: #212529;">üîÑ Reboot</button><button id="poweroffBtn" class="stop-btn">üîå Power Off</button></div></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const App = {
        state: { port: null, reader: null, writer: null, isReading: false, onDataDisposable: null, fileDownloadInProgress: false, fileDownloadBuffer: '', },
        ui: {},
        term: new Terminal({ cursorBlink: true, fontFamily: 'monospace', fontSize: 14, theme: { background: '#1e1e1e', foreground: '#d4d4d4', cursor: '#d4d4d4', selectionBackground: 'rgba(255, 255, 255, 0.2)' } }),
        fitAddon: new FitAddon.FitAddon(),

        init() {
            if (!navigator.serial) {
                alert("Web Serial API is not supported. Please use a modern browser like Chrome or Edge.");
                return;
            }
            this.cacheUI();
            this.setupTerminal();
            this.setGuiEnabled(false);
            this.bindEvents();
        },
        
        cacheUI() {
            const ids = [
                'connectBtn', 'disconnectBtn', 'baudRateSelect', 'rootLoginBtn', 'clearTermBtn', 'terminal-container',
                'ethtoolParamSelect', 'ethtoolIfaceInput', 'runEthtoolBtn', 'tcpdumpInput', 'runTcpdumpBtn',
                'ptp4lIfaceInput', 'runPtp4lBtn',
                'iperfClientInput', 'runIperfClientBtn',
                'candumpInput', 'runCandumpBtn', 'cansendInput', 'sendCanBtn',
                'killPidInput', 'killBtn',
                'fileInput', 'remotePathInput', 'uploadFileBtn', 'downloadPathInput', 'downloadFileBtn', 'status',
                'rebootBtn', 'poweroffBtn'
            ];
            ids.forEach(id => {
                const el = document.getElementById(id);
                const key = id.replace(/-/g, '');
                this.ui[key] = el;
            });
            this.ui.cmdBtns = document.querySelectorAll('.cmd-btn');
            this.ui.guiControls = document.querySelectorAll('#gui-pane button, #gui-pane input, #gui-pane select, #rootLoginBtn');
        },

        setupTerminal() {
            this.term.loadAddon(this.fitAddon);
            this.term.open(this.ui.terminalcontainer);
            this.fitAddon.fit();
            new ResizeObserver(() => this.fitAddon.fit()).observe(this.ui.terminalcontainer);
        },

        setGuiEnabled(enabled) {
            this.ui.guiControls.forEach(c => c.disabled = !enabled);
            this.ui.connectBtn.disabled = enabled;
            this.ui.disconnectBtn.disabled = !enabled;
            this.ui.baudRateSelect.disabled = enabled;
        },

        async sendSerial(data) {
            if (!this.state.port?.writable) return;
            try {
                const writer = this.state.port.writable.getWriter();
                await writer.write(new TextEncoder().encode(data));
                writer.releaseLock();
            } catch (e) { this.term.writeln(`\r\n\x1b[31m[ERROR] Write failed: ${e.message}\x1b[0m`); }
        },

        async sendCommand(cmd, showInTerm = true) {
            if (this.state.port && cmd) {
                this.term.focus();
                if(showInTerm) this.term.writeln(`\x1b[36m$ ${cmd}\x1b[0m`);
                await this.sendSerial(cmd + '\r');
            }
        },

        async connect() {
            if (this.state.port) return;
            try {
                this.state.port = await navigator.serial.requestPort();
                await this.state.port.open({ baudRate: parseInt(this.ui.baudRateSelect.value, 10) });
                this.setGuiEnabled(true);
                this.state.isReading = true;
                this.readLoop();
                this.term.writeln('\x1b[32m[SYSTEM] Connected.\x1b[0m');
                this.term.focus();
                this.state.onDataDisposable = this.term.onData(data => {
                    if (!this.state.fileDownloadInProgress) { this.sendSerial(data); }
                });
            } catch (error) { this.term.writeln(`\r\n\x1b[31m[ERROR] ${error.message}\x1b[0m`); this.state.port = null; }
        },
        
        async disconnect() {
            const portToClose = this.state.port; if (!portToClose) return;
            this.state.isReading = false;
            if (this.state.onDataDisposable) { this.state.onDataDisposable.dispose(); this.state.onDataDisposable = null; }
            if (this.state.reader) { try { await this.state.reader.cancel(); } catch (e) {} }
            try { await portToClose.close(); } catch (e) {}
            if (this.state.port === portToClose) {
                this.state.port = null; this.state.reader = null; this.setGuiEnabled(false);
                this.term.writeln('\r\n\x1b[33m[SYSTEM] Disconnected.\x1b[0m');
            }
        },
        
        async readLoop() {
            while (this.state.port?.readable && this.state.isReading) {
                const textDecoder = new TextDecoder();
                this.state.reader = this.state.port.readable.getReader();
                try {
                    while (true) {
                        const { value, done } = await this.state.reader.read();
                        if (done) { this.state.reader.releaseLock(); break; }
                        const decodedChunk = textDecoder.decode(value, { stream: true });
                        if (this.state.fileDownloadInProgress) { this.handleFileDownloadChunk(decodedChunk); } 
                        else { this.term.write(decodedChunk); }
                    }
                } catch (error) { if (this.state.isReading) { this.term.writeln(`\r\n\x1b[31m[ERROR] Read loop failed: ${error.message}\x1b[0m`); } }
            }
        },

        handleFileUpload() {
            const file = this.ui.fileInput.files[0];
            const remotePath = this.ui.remotePathInput.value.trim();
            if (!file || !remotePath) { this.ui.status.textContent = "Select file and enter destination path."; return; }
            const reader = new FileReader();
            this.ui.status.textContent = `Reading ${file.name}...`;
            this.ui.uploadFileBtn.disabled = true;
            reader.onload = (e) => {
                const base64Content = e.target.result.split(',')[1];
                const cmd = `echo '${base64Content}' | base64 -d > ${remotePath}`;
                this.ui.status.textContent = `Uploading to ${remotePath}...`;
                this.sendCommand(cmd, false).then(() => {
                    this.term.writeln(`\r\n\x1b[32m[SYSTEM] Upload command sent.\x1b[0m`);
                    this.ui.status.textContent = 'Upload initiated.';
                });
            };
            reader.onloadend = () => { this.ui.uploadFileBtn.disabled = false; };
            reader.onerror = (err) => { this.ui.status.textContent = `Error reading file: ${err}`; };
            reader.readAsDataURL(file);
        },
        
        handleFileDownload() {
            const path = this.ui.downloadPathInput.value.trim();
            if (!path) { this.ui.status.textContent = 'Enter a file path to download.'; return; }
            if (this.state.fileDownloadInProgress) { this.ui.status.textContent = 'Download already in progress.'; return; }
            this.state.fileDownloadInProgress = true;
            this.state.fileDownloadBuffer = '';
            this.ui.status.textContent = `Requesting ${path}...`;
            this.sendCommand(`if [ -f "${path}" ]; then cat "${path}" | base64; echo; fi; echo "DOWNLOAD_END"`, false);
        },

        handleFileDownloadChunk(chunk) {
            this.state.fileDownloadBuffer += chunk;
            const endMarker = 'DOWNLOAD_END';
            if (this.state.fileDownloadBuffer.includes(endMarker)) {
                const fileData = this.state.fileDownloadBuffer.substring(0, this.state.fileDownloadBuffer.indexOf(endMarker)).trim();
                this.state.fileDownloadInProgress = false;
                this.state.fileDownloadBuffer = '';
                if (fileData.length === 0) {
                     this.term.writeln('\r\n\x1b[33m[SYSTEM] Download failed (file not found or empty).\x1b[0m');
                     this.ui.status.textContent = 'Download failed.';
                     return;
                }
                this.term.writeln('\r\n\x1b[32m[SYSTEM] Data received. Decoding...\x1b[0m');
                this.ui.status.textContent = 'Decoding...';
                this.saveDownloadedFile(fileData);
            }
        },

        saveDownloadedFile(base64Data) {
            try {
                const byteCharacters = atob(base64Data);
                const byteArray = new Uint8Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) { byteArray[i] = byteCharacters.charCodeAt(i); }
                const blob = new Blob([byteArray]);
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const filename = this.ui.downloadPathInput.value.split('/').pop() || 'downloaded_file';
                link.download = filename;
                link.click();
                link.remove();
                this.term.writeln(`\x1b[32m[SYSTEM] File "${filename}" downloaded.\x1b[0m`);
                this.ui.status.textContent = `File "${filename}" downloaded.`;
            } catch (e) { 
                this.term.writeln(`\x1b[31m[ERROR] Decode/save failed: ${e.message}\x1b[0m`);
                this.ui.status.textContent = 'Error: Failed to decode file.';
            }
        },

        bindEvents() {
            this.ui.connectBtn.addEventListener('click', () => this.connect());
            this.ui.disconnectBtn.addEventListener('click', () => this.disconnect());
            this.ui.clearTermBtn.addEventListener('click', () => this.term.clear());
            this.ui.rootLoginBtn.addEventListener('click', () => this.sendCommand('root', true));
            this.ui.cmdBtns.forEach(b => b.addEventListener('click', () => this.sendCommand(b.dataset.cmd)));
            
            // --- Specialized Button Logic ---
            this.ui.runEthtoolBtn.addEventListener('click', () => { const p = this.ui.ethtoolParamSelect.value; const i = this.ui.ethtoolIfaceInput.value.trim(); if(i) this.sendCommand(`ethtool ${p} ${i}`); });
            this.ui.runPtp4lBtn.addEventListener('click', () => { const i = this.ui.ptp4lIfaceInput.value.trim(); if(i) this.sendCommand(`ptp4l -2 -H -m -s -i ${i} &`); });
            this.ui.runTcpdumpBtn.addEventListener('click', () => { const o = this.ui.tcpdumpInput.value.trim(); if(o) { this.sendCommand(`tcpdump ${o} &`); } });
            this.ui.runIperfClientBtn.addEventListener('click', () => { const o = this.ui.iperfClientInput.value.trim(); if(o) this.sendCommand(`iperf3 -c ${o}`); });
            this.ui.runCandumpBtn.addEventListener('click', () => { const i = this.ui.candumpInput.value.trim(); if(i) this.sendCommand(`candump ${i} &`); });
            this.ui.sendCanBtn.addEventListener('click', () => { const c = this.ui.cansendInput.value.trim(); if(c) this.sendCommand(`cansend ${c}`); });
            this.ui.killBtn.addEventListener('click', () => { const p = this.ui.killPidInput.value.trim(); if(p && confirm(`Kill PID ${p}?`)) this.sendCommand(`kill -9 ${p}`); });
            this.ui.uploadFileBtn.addEventListener('click', () => this.handleFileUpload());
            this.ui.downloadFileBtn.addEventListener('click', () => this.handleFileDownload());
            this.ui.rebootBtn.addEventListener('click', () => { if(confirm('REBOOT the device?')) this.sendCommand('reboot'); });
            this.ui.poweroffBtn.addEventListener('click', () => { if(confirm('POWER OFF the device?')) this.sendCommand('poweroff'); });
        }
    };
    App.init();
});
</script>
</body>
</html>
