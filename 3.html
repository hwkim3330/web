<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>S32G Ultimate Control Center</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<style>
:root {
--bg-primary: #1e1e1e; --bg-secondary: #252526; --bg-input: #3c3c3c;
--border-color: #4a4a4a; --text-primary: #d4d4d4; --text-secondary: #cccccc;
--accent-blue: #3794ff; --accent-green: #38a169; --accent-yellow: #d19a66; --accent-red: #e06c75; --accent-purple: #c678dd;
--font-main: 'JetBrains Mono', 'Fira Code', Menlo, Monaco, 'Courier New', monospace;
}
html, body {
    height: 100%; margin: 0; padding: 0; background-color: var(--bg-primary); color: var(--text-primary);
    font-family: var(--font-main); overflow: hidden;
}
#page-container { display: flex; height: 100%; padding: 15px; gap: 15px; box-sizing: border-box; }
.pane { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; display: flex; flex-direction: column; }
#terminal-pane { flex: 1.2; min-width: 0; }
#gui-pane { flex: 1; overflow-y: auto; }
#controls { padding: 10px 15px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; border-bottom: 1px solid var(--border-color); }
#terminal-container { flex-grow: 1; padding: 10px; border-radius: 0 0 8px 8px; }
.xterm .xterm-viewport { background-color: transparent !important; }
button, select, input {
    background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border-color);
    padding: 8px 12px; font-size: 14px; cursor: pointer; border-radius: 5px; transition: all 0.2s;
    display: flex; align-items: center; gap: 8px; font-family: var(--font-main);
}
button:hover:not(:disabled) { background-color: #4c4c4c; border-color: #6a6a6a; }
button:disabled { background-color: #2a2a2a; color: #666; cursor: not-allowed; }
button i { flex-shrink: 0; }
.status-panel { padding: 10px 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; border-bottom: 1px solid var(--border-color); background-color: #1a1a1a; }
.status-item { display: flex; align-items: center; gap: 8px; font-size: 14px; }
.status-item span { color: var(--text-secondary); }
#linkStatus.up { color: var(--accent-green); } #linkStatus.down { color: var(--accent-red); }
.gui-section { margin: 15px; }
.gui-section h3 { margin: 0 0 12px 0; color: var(--accent-blue); display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; font-size: 16px; }
.button-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; }
.input-group { margin-top: 15px; display: flex; flex-direction: column; gap: 10px; padding: 12px; background-color: var(--bg-primary); border-radius: 5px; }
.input-group-row { display: flex; gap: 10px; align-items: center; }
.input-group-row input { flex-grow: 1; }
.input-group-row button { flex-grow: 1; justify-content: center; }
.input-group label { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; display: block; }
</style>
</head>
<body>
<div id="page-container">
    <div id="terminal-pane" class="pane">
        <div id="controls">
            <button id="connectBtn" style="background:var(--accent-green);"><i data-lucide="zap"></i>Connect</button>
            <button id="disconnectBtn" disabled><i data-lucide="zap-off"></i>Disconnect</button>
            <select id="baudRateSelect"><option value="115200" selected>115200</option></select>
            <button id="clearTermBtn"><i data-lucide="trash-2"></i>Clear</button>
            <button id="rootLoginBtn" style="margin-left:auto;"><i data-lucide="user-cog"></i>root Login</button>
            <button id="enterBtn"><i data-lucide="corner-down-left"></i>Enter</button>
        </div>
        <div id="terminal-container"></div>
    </div>
    <div id="gui-pane" class="pane">
        <div class="status-panel">
            <div class="status-item"><i data-lucide="network"></i><span>IP (eth0):</span><strong id="ipAddress">N/A</strong></div>
            <div class="status-item"><i data-lucide="link"></i><span>Link (eth0):</span><strong id="linkStatus" class="down">Down</strong></div>
            <div class="status-item"><i data-lucide="fingerprint"></i><span>MAC (eth0):</span><strong id="macAddress">N/A</strong></div>
        </div>

        <div class="gui-section">
            <h3><i data-lucide="route"></i>TSN - Traffic Control (tc)</h3>
            <div class="button-grid">
                <button class="cmd-btn" data-cmd="tc qdisc show dev eth0"><i data-lucide="list-tree"></i>Show Rules</button>
                <button id="tcDelBtn" style="background:var(--accent-red);"><i data-lucide="x-circle"></i>Delete All Rules</button>
            </div>
            <div class="input-group">
                <label>CBS (Credit-Based Shaper)</label>
                <div class="input-group-row">
                    <input id="cbsIdle" type="text" placeholder="idleslope (e.g. 50000)">
                    <input id="cbsSend" type="text" placeholder="sendslope (e.g. -950000)">
                </div>
                <div class="input-group-row">
                    <input id="cbsHi" type="text" placeholder="hilimit (e.g. 6000)">
                    <input id="cbsLo" type="text" placeholder="lolimit (e.g. -940000)">
                </div>
                <div class="input-group-row"><button id="cbsApplyBtn" style="background:var(--accent-purple);"><i data-lucide="move-horizontal"></i>Apply CBS to eth0</button></div>
            </div>
             <div class="input-group">
                <label>TAS (Time-Aware Shaper) - Example Entry</label>
                <input id="tasBaseTime" type="text" placeholder="base-time (ns since epoch) e.g. 1528200000000000000">
                <textarea id="tasSchedEntry" placeholder="sched-entry S 01 500000
sched-entry S 02 500000" style="height:60px; background: var(--bg-input); border-radius:5px; color:var(--text-primary); font-family:var(--font-main);"></textarea>
                <div class="input-group-row"><button id="tasApplyBtn" style="background:var(--accent-purple);"><i data-lucide-="timer"></i>Apply TAS to eth0</button></div>
            </div>
        </div>

        <div class="gui-section">
            <h3><i data-lucide="ethernet-port"></i>Ethernet Diagnostics (ethtool)</h3>
            <div class="button-grid">
                <button class="cmd-btn" data-cmd="ethtool eth0"><i data-lucide="link-2"></i>Link Status</button>
                <button class="cmd-btn" data-cmd="ethtool -i eth0"><i data-lucide="info"></i>Driver Info</button>
                <button class="cmd-btn" data-cmd="ethtool -l eth0"><i data-lucide="git-merge"></i>Channels</button>
                <button class="cmd-btn" data-cmd="ethtool -T eth0"><i data-lucide="clock"></i>Timestamps (PTP)</button>
                <button class="cmd-btn" data-cmd="ethtool -S eth0"><i data-lucide="bar-chart-big"></i>Statistics</button>
            </div>
        </div>

        <div class="gui-section">
            <h3><i data-lucide="globe"></i>Network State (ip)</h3>
             <div class="button-grid">
                <button class="cmd-btn" data-cmd="ip addr show dev eth0"><i data-lucide="network"></i>IP (eth0)</button>
                <button class="cmd-btn" data-cmd="ip route"><i data-lucide="milestone"></i>Route Table</button>
                <button class="cmd-btn" data-cmd="ip neigh"><i data-lucide="users"></i>ARP/Neigh Table</button>
                <button id="pingBtn"><i data-lucide="send"></i>Ping Google</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const App = {
        state: { port: null, isReading: false, lastCommand: '', ipAddress: 'N/A', macAddress: 'N/A', linkStatus: 'Down' },
        ui: {},
        term: new Terminal({
            cursorBlink: true, fontFamily: 'var(--font-main)', fontSize: 14,
            theme: { background: 'transparent', foreground: '#d4d4d4', cursor: '#d4d4d4', selectionBackground: '#555' }
        }),
        fitAddon: new FitAddon.FitAddon(),

        methods: {
            init() {
                if (!navigator.serial) {
                    alert("Web Serial API not supported. Use Chrome/Edge. On Linux, run 'sudo usermod -a -G dialout $USER' and reboot.");
                    return;
                }
                this.cacheUI();
                this.term.loadAddon(this.fitAddon);
                this.term.open(this.ui.terminalContainer);
                this.fitAddon.fit();
                new ResizeObserver(() => this.fitAddon.fit()).observe(this.ui.terminalContainer);
                this.setGuiEnabled(false);
                this.bindEvents();
                lucide.createIcons();
            },
            
            cacheUI() {
                const ids = ['connectBtn', 'disconnectBtn', 'baudRateSelect', 'terminalContainer', 'clearTermBtn', 'rootLoginBtn', 'enterBtn', 'ipAddress', 'macAddress', 'linkStatus', 'tcDelBtn', 'cbsIdle', 'cbsSend', 'cbsHi', 'cbsLo', 'cbsApplyBtn', 'tasBaseTime', 'tasSchedEntry', 'tasApplyBtn', 'pingBtn'];
                ids.forEach(id => this.ui[id] = document.getElementById(id));
                this.ui.guiControls = document.querySelectorAll('#gui-pane button, #gui-pane input, #gui-pane select');
            },

            setGuiEnabled(enabled) {
                this.ui.guiControls.forEach(c => c.disabled = !enabled);
                this.ui.connectBtn.disabled = enabled;
                this.ui.disconnectBtn.disabled = !enabled;
                this.ui.baudRateSelect.disabled = enabled;
            },

            updateStatusPanel() {
                this.ui.ipAddress.textContent = this.state.ipAddress;
                this.ui.macAddress.textContent = this.state.macAddress;
                this.ui.linkStatus.textContent = this.state.linkStatus;
                this.ui.linkStatus.className = this.state.linkStatus === 'Up' ? 'up' : 'down';
            },

            outputParser(data) {
                if (this.state.lastCommand.includes('ip addr')) {
                    const ipMatch = data.match(/inet\s+([0-9.]+)/);
                    if (ipMatch) this.state.ipAddress = ipMatch[1];
                    const macMatch = data.match(/link\/ether\s+([0-9a-f:]+)/);
                    if (macMatch) this.state.macAddress = macMatch[1];
                }
                if (this.state.lastCommand.startsWith('ethtool eth0')) {
                    if (data.includes('Link detected: yes')) this.state.linkStatus = 'Up';
                    else if (data.includes('Link detected: no')) this.state.linkStatus = 'Down';
                }
                this.updateStatusPanel();
            },

            async sendSerial(data) {
                if (!this.state.port?.writable) return;
                try {
                    const writer = this.state.port.writable.getWriter();
                    await writer.write(new TextEncoder().encode(data));
                    writer.releaseLock();
                } catch (e) { this.term.writeln(`\r\n\x1b[31m[E] Write failed\x1b[0m`); }
            },

            async sendCommand(cmd, showInTerm = true) {
                if (this.state.port && cmd) {
                    this.state.lastCommand = cmd;
                    this.term.focus();
                    if(showInTerm) this.term.writeln(`\x1b[36m$ ${cmd}\x1b[0m`);
                    await this.sendSerial(cmd + '\r');
                }
            },
            
            async connect() {
                try {
                    this.state.port = await navigator.serial.requestPort();
                    await this.state.port.open({ baudRate: parseInt(this.ui.baudRateSelect.value, 10) });
                    this.setGuiEnabled(true);
                    this.state.isReading = true;
                    this.readLoop();
                    this.term.writeln('\x1b[32m[SYSTEM] Connected. Probing network status...\x1b[0m');
                    setTimeout(() => this.sendCommand('ip addr show dev eth0', false), 500);
                    setTimeout(() => this.sendCommand('ethtool eth0', false), 1000);
                } catch (error) { this.term.writeln(`\r\n\x1b[31m[E] ${error.message}\x1b[0m`); }
            },
            
            async disconnect() {
                const portToClose = this.state.port; if (!portToClose) return;
                this.state.isReading = false;
                if (this.state.onDataDisposable) this.state.onDataDisposable.dispose();
                if (portToClose.readable) { try { await portToClose.readable.getReader().cancel(); } catch(e) {} }
                try { await portToClose.close(); } catch(e) {}
                if (this.state.port === portToClose) {
                    this.state = { ...this.state, port: null, ipAddress: 'N/A', macAddress: 'N/A', linkStatus: 'Down' };
                    this.updateStatusPanel();
                    this.setGuiEnabled(false);
                    this.term.writeln('\r\n\x1b[33m[SYSTEM] Disconnected.\x1b[0m');
                }
            },
            
            async readLoop() {
                const textDecoder = new TextDecoder();
                while (this.state.port?.readable && this.state.isReading) {
                    const reader = this.state.port.readable.getReader();
                    try {
                        while (true) {
                            const { value, done } = await reader.read(); if (done) break;
                            const text = textDecoder.decode(value);
                            this.term.write(text);
                            this.outputParser(text);
                        }
                    } catch (error) {
                    } finally { reader.releaseLock(); }
                }
            },

            bindEvents() {
                this.ui.connectBtn.addEventListener('click', () => this.connect());
                this.ui.disconnectBtn.addEventListener('click', () => this.disconnect());
                navigator.serial?.addEventListener('disconnect', (e) => { if (e.target === this.state.port) this.disconnect(); });
                this.ui.clearTermBtn.addEventListener('click', () => this.term.clear());
                document.querySelectorAll('.cmd-btn').forEach(b => b.addEventListener('click', () => this.sendCommand(b.dataset.cmd)));
                
                // System
                this.ui.rootLoginBtn.addEventListener('click', () => this.sendCommand('root'));
                this.ui.enterBtn.addEventListener('click', () => this.sendSerial('\r'));
                this.ui.pingBtn.addEventListener('click', () => this.sendCommand('ping -c 4 8.8.8.8'));
                
                // TC
                this.ui.tcDelBtn.addEventListener('click', () => { if(confirm('Delete all tc rules on eth0?')) this.sendCommand('tc qdisc del dev eth0 root'); });
                this.ui.cbsApplyBtn.addEventListener('click', () => {
                    const idle = this.ui.cbsIdle.value.trim(); const send = this.ui.cbsSend.value.trim();
                    const hi = this.ui.cbsHi.value.trim(); const lo = this.ui.cbsLo.value.trim();
                    if(idle && send && hi && lo) {
                        this.sendCommand(`tc qdisc replace dev eth0 parent root cbs idleslope ${idle} sendslope ${send} hilimit ${hi} lolimit ${lo}`);
                    } else { alert('Please fill all CBS fields.'); }
                });
                this.ui.tasApplyBtn.addEventListener('click', () => {
                    const baseTime = this.ui.tasBaseTime.value.trim();
                    const schedEntries = this.ui.tasSchedEntry.value.trim().split('\n').map(e => e.trim()).filter(e => e);
                    if(baseTime && schedEntries.length > 0) {
                        const schedCmd = schedEntries.join(' ');
                        this.sendCommand(`tc qdisc replace dev eth0 parent root tas clockid CLOCK_TAI base-time ${baseTime} ${schedCmd}`);
                    } else { alert('Please provide Base Time and at least one Schedule Entry.'); }
                });
            }
        }
    };
    
    App.methods.init();
});
</script>
</body>
</html>
