<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>S32G Pro Control Deck</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <style>
        :root {
            --bg-base: #161617;
            --bg-panel: rgba(44, 44, 46, 0.7);
            --bg-panel-solid: #2c2c2e;
            --bg-input: #3a3a3c;
            --border-color: rgba(84, 84, 88, 0.65);
            --text-primary: #f5f5f7;
            --text-secondary: #a1a1a6;
            --accent-blue: #0a84ff;
            --accent-blue-hover: #369aff;
            --accent-red: #ff453a;
            --accent-red-hover: #ff6861;
            --accent-green: #30d158;
            --accent-gray: #8e8e93;
            --font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body, html {
            height: 100%; margin: 0; padding: 0; background-color: var(--bg-base);
            color: var(--text-primary); font-family: var(--font-family); font-size: 14px; overflow: hidden;
        }

        #page-container { display: flex; height: 100vh; }
        #gui-pane {
            flex: 0 0 480px; background-color: var(--bg-base); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; backdrop-filter: blur(20px);
        }
        #terminal-pane { flex: 1; min-width: 0; display: flex; flex-direction: column; }

        .gui-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); }
        .gui-header h1 { margin: 0; font-size: 26px; font-weight: 600; }
        .gui-header p { margin: 4px 0 0; color: var(--text-secondary); font-size: 15px; }

        .gui-main { overflow-y: auto; padding: 20px; flex-grow: 1; }
        .gui-main::-webkit-scrollbar { width: 6px; }
        .gui-main::-webkit-scrollbar-thumb { background: var(--accent-gray); border-radius: 3px; }
        .gui-main::-webkit-scrollbar-track { background: transparent; }

        #controls-bar {
            padding: 12px 16px; background-color: var(--bg-panel-solid); display: flex;
            gap: 12px; align-items: center; border-bottom: 1px solid var(--border-color);
        }
        #terminal-container { flex-grow: 1; padding: 10px; }

        .gui-section {
            margin-bottom: 20px; background-color: var(--bg-panel); border-radius: 12px;
            border: 1px solid var(--border-color); overflow: hidden;
        }
        .gui-section h3 {
            display: flex; align-items: center; gap: 10px; padding: 12px 16px; margin: 0;
            font-size: 1em; font-weight: 600; border-bottom: 1px solid var(--border-color);
            background: rgba(0,0,0,0.1);
        }
        .gui-section h3 svg { stroke: var(--text-secondary); }
        .gui-section .content { padding: 16px; display: flex; flex-direction: column; gap: 14px; }
        .content .description { color: var(--text-secondary); margin: -10px 0 5px; font-size: 13px; }

        .input-group { display: flex; gap: 10px; align-items: center; }
        .input-group label { font-size: 13px; color: var(--text-secondary); flex-shrink: 0; }

        button, select, input, textarea {
            background-color: var(--bg-input); color: var(--text-primary);
            border: 1px solid var(--border-color); padding: 9px 12px; border-radius: 8px;
            font-family: inherit; font-size: 14px; transition: all 0.2s ease;
        }
        input[type="file"] { padding: 6px; }
        textarea { resize: vertical; }
        button { cursor: pointer; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 8px; background-color: #515154; }
        button:hover:not(:disabled) { filter: brightness(1.2); }
        button:active:not(:disabled) { filter: brightness(0.9); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn { width: 100%; }
        .btn-primary { background-color: var(--accent-blue); }
        .btn-danger { background-color: var(--accent-red); }
        .btn-success { background-color: var(--accent-green); }
        .btn-secondary { background-color: var(--accent-gray); }

        #status-indicator { width: 10px; height: 10px; border-radius: 50%; background-color: var(--accent-red); transition: background-color 0.3s ease; }
        #status-indicator.connected { background-color: var(--accent-green); }

        .spinner {
            width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        button .spinner { display: none; }
        button.loading .btn-text { display: none; }
        button.loading .spinner { display: block; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .progress-bar { width: 100%; height: 6px; background-color: var(--bg-input); border-radius: 3px; overflow: hidden; display: none; }
        .progress-bar-fill { width: 0%; height: 100%; background-color: var(--accent-blue); transition: width 0.1s linear; }

        hr { border: none; height: 1px; background-color: var(--border-color); margin: 4px 0; }

        @media (max-width: 1200px) { #gui-pane { display: none; } }
    </style>
</head>
<body>
<div id="page-container">
    <div id="gui-pane">
        <header class="gui-header"><h1>S32G Pro Control Deck</h1><p>Professional Web Interface for NXP S32G</p></header>
        <main class="gui-main">
            <!-- SECTIONS WILL BE HERE -->
        </main>
    </div>
    <div id="terminal-pane">
        <div id="controls-bar">
            <div id="status-indicator" title="Disconnected"></div>
            <button id="connectBtn" class="btn-primary" style="width: 120px;"><span class="btn-text">Connect</span><div class="spinner"></div></button>
            <button id="disconnectBtn" class="btn-danger" style="width: 120px;" disabled><span class="btn-text">Disconnect</span></button>
            <select id="baudRateSelect"><option value="115200">115200</option><option value="9600">9600</option></select>
            <button id="rootLoginBtn" class="btn-primary" disabled style="width: 120px;"><span class="btn-text">Login as root</span></button>
            <button id="clearTermBtn" class="btn-secondary" style="margin-left: auto; width: 100px;">Clear</button>
        </div>
        <div id="terminal-container"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    class S32GControlDeck {
        constructor() {
            this.state = {
                port: null,
                reader: null,
                writer: null,
                isReading: false,
                isCommandRunning: false,
                activeProcesses: { ptp: null, candump: null },
                fileTransfer: {
                    inProgress: false,
                    type: null, // 'upload' or 'download'
                    buffer: '',
                    totalSize: 0,
                    transferredSize: 0,
                }
            };
            this.ui = {};
            this.term = new Terminal({
                cursorBlink: true,
                fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                fontSize: 14,
                theme: {
                    background: '#161617', foreground: '#f5f5f7', cursor: '#0a84ff',
                    selectionBackground: 'rgba(10, 132, 255, 0.3)',
                    black: '#2c2c2e', red: '#ff453a', green: '#30d158', yellow: '#ffcc00',
                    blue: '#0a84ff', magenta: '#ff375f', cyan: '#5ac8fa', white: '#f5f5f7',
                    brightBlack: '#8e8e93', brightRed: '#ff6861', brightGreen: '#63e68c',
                    brightYellow: '#ffee58', brightBlue: '#369aff', brightMagenta: '#ff6487',
                    brightCyan: '#83d9fc', brightWhite: '#ffffff'
                },
                allowTransparency: true
            });
            this.fitAddon = new FitAddon.FitAddon();
            this.onDataDisposable = null;
        }

        init() {
            if (!navigator.serial) {
                alert("Web Serial API is not supported in this browser. Please use Chrome or Edge.");
                return;
            }
            this.renderSections();
            this.cacheUI();
            this.setupTerminal();
            this.setGuiEnabled(false);
            this.bindEvents();
        }

        renderSections() {
            const main = document.querySelector('.gui-main');
            main.innerHTML = `
                <section class="gui-section"><h3><svg width="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10s-2 2-5 2-5-2-5-2"/><path d="M3 10s2 2 5 2 5-2 5-2"/><path d="M12 2a2.5 2.5 0 0 1 2.5 2.5V10"/><path d="M12 14v7.5a2.5 2.5 0 0 1-5 0V14"/><line x1="7" y1="10" x2="7" y2="14"/><line x1="17" y1="10" x2="17" y2="14"/></svg>Management Port (end0)</h3><div class="content"><p class="description">One-click setup for interface <strong>end0</strong>.</p><button id="setupGmacBtn" class="btn btn-primary"><span class="btn-text">1. Set Board IP (169.254.59.171)</span><div class="spinner"></div></button><button id="pingHostBtn" class="btn btn-primary"><span class="btn-text">2. Ping Host (169.254.59.170)</span><div class="spinner"></div></button></div></section>
                <section class="gui-section"><h3><svg width="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/><path d="M12 12a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>One-Click TSN Demo</h3><div class="content"><p class="description">Configures MQPRIO, CBS, and PTP on <strong>end0</strong>.</p><button id="tsnDemoBtn" class="btn btn-primary"><span class="btn-text">▶️ Start TSN Demo</span><div class="spinner"></div></button><button id="stopTsnDemoBtn" class="btn btn-danger"><span class="btn-text">⏹️ Stop & Clean Up</span><div class="spinner"></div></button></div></section>
                <section class="gui-section"><h3><svg width="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M6 20v-2M18 20v-4"/><path d="M12 14v-4M6 14V8M18 14v-2"/></svg>Advanced PTP Control</h3><div class="content"><div class="input-group"><input id="ptp4lIfaceInput" type="text" value="end0" placeholder="Iface"><select id="ptp4lTsSelect" style="width: auto;"><option value="-H">HW</option><option value="-S">SW</option></select><select id="ptp4lTransportSelect" style="width: auto;"><option value="-2">L2</option><option value="-4">UDPv4</option></select><input id="ptp4lDomainInput" type="number" value="0" style="width: 80px;" title="Domain"></div><div class="input-group"><button id="runPtp4lBtn" class="btn btn-primary"><span class="btn-text">▶️ Start PTP</span><div class="spinner"></div></button><button id="stopPtp4lBtn" class="btn btn-danger"><span class="btn-text">⏹️ Stop</span><div class="spinner"></div></button></div></div></section>
                <section class="gui-section"><h3><svg width="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8V2l11.16 11.16M22 8a5 5 0 0 0-3.9-3.9M14.05 6A9 9 0 0 1 22 13.95M22 22V16"/></svg>Advanced TC (taprio)</h3><div class="content"><div class="input-group"><label>Iface:</label><input id="tcIfaceInput" value="end0"><label>Num TC:</label><input id="tcNumTcInput" type="number" value="5" style="width:80px"></div><textarea id="tcSchedEntryTextarea" rows="3" placeholder="One sched-entry per line">sched-entry S 1e 500000\nsched-entry S 01 500000</textarea><div class="input-group"><button id="runTcBtn" class="btn btn-primary"><span class="btn-text">Apply Qdisc</span><div class="spinner"></div></button><button id="deleteTcBtn" class="btn btn-danger"><span class="btn-text">Delete Qdisc</span><div class="spinner"></div></button></div></div></section>
                <section class="gui-section"><h3><svg width="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.2 15c.7-1.2 1-2.5.7-3.9-.6-2.4-2.2-4.4-4.6-5.5-.9-.4-1.8-.7-2.8-.8A4.94 4.94 0 0 0 12 2a4.95 4.95 0 0 0-4.5 3c-1.1.1-2.2.4-3.1.8-2.3 1.1-4 3.1-4.6 5.5-.3 1.4 0 2.7.7 3.9l.6.9.2.5H20.4l.2-.5.6-.9z"/></svg>File Transfer</h3><div class="content"><div class="input-group"><input type="file" id="fileInput"><button id="uploadFileBtn" class="btn btn-primary"><span class="btn-text">⬆️ Upload</span><div class="spinner"></div></button></div><div class="input-group"><input id="remotePathInput" placeholder="/tmp/uploaded_file"></div><div class="progress-bar" id="uploadProgressBar"><div class="progress-bar-fill"></div></div><p id="uploadStatus" class="description"></p><hr><div class="input-group"><input id="downloadPathInput" placeholder="/tmp/capture.pcap"><button id="downloadFileBtn" class="btn btn-primary"><span class="btn-text">⬇️ Download</span><div class="spinner"></div></button></div><div class="progress-bar" id="downloadProgressBar"><div class="progress-bar-fill"></div></div><p id="downloadStatus" class="description"></p></div></section>
                <section class="gui-section"><h3><svg width="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M3 20h2"/><path d="M18 4H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/><path d="M12 16v4"/><path d="M9 20h.01"/><path d="M6 20h.01"/></svg>CAN Bus</h3><div class="content"><div class="input-group"><button id="can0StatsBtn" class="btn btn-secondary"><span class="btn-text">CAN0 Stats</span><div class="spinner"></div></button><button id="can1StatsBtn" class="btn btn-secondary"><span class="btn-text">CAN1 Stats</span><div class="spinner"></div></button></div><hr><div class="input-group"><input id="candumpInput" value="any" placeholder="Iface"><button id="runCandumpBtn" class="btn btn-primary"><span class="btn-text">▶️ Sniff</span><div class="spinner"></div></button><button id="stopCandumpBtn" class="btn btn-danger"><span class="btn-text">⏹️ Stop</span><div class="spinner"></div></button></div><hr><div class="input-group"><input id="cansendInput" value="can0 123#112233" placeholder="<iface> <id>#<data>"><button id="sendCanBtn" class="btn btn-primary"><span class="btn-text">Send</span><div class="spinner"></div></button></div></div></section>
            `;
        }

        cacheUI() {
            const ids = [
                'connectBtn', 'disconnectBtn', 'baudRateSelect', 'rootLoginBtn', 'clearTermBtn', 'terminal-container', 'status-indicator',
                'setupGmacBtn', 'pingHostBtn', 'tsnDemoBtn', 'stopTsnDemoBtn',
                'ptp4lIfaceInput', 'ptp4lTsSelect', 'ptp4lTransportSelect', 'ptp4lDomainInput', 'runPtp4lBtn', 'stopPtp4lBtn',
                'tcIfaceInput', 'tcNumTcInput', 'tcSchedEntryTextarea', 'runTcBtn', 'deleteTcBtn',
                'can0StatsBtn', 'can1StatsBtn', 'candumpInput', 'runCandumpBtn', 'stopCandumpBtn', 'cansendInput', 'sendCanBtn',
                'fileInput', 'remotePathInput', 'uploadFileBtn', 'downloadPathInput', 'downloadFileBtn',
                'uploadStatus', 'downloadStatus', 'uploadProgressBar', 'downloadProgressBar'
            ];
            ids.forEach(id => this.ui[id] = document.getElementById(id));
            this.ui.guiControls = document.querySelectorAll('#gui-pane button, #gui-pane input, #gui-pane select, #gui-pane textarea');
        }

        setupTerminal() {
            this.term.loadAddon(this.fitAddon);
            this.term.open(this.ui.terminalcontainer);
            this.fitAddon.fit();
            new ResizeObserver(() => this.fitAddon.fit()).observe(this.ui.terminalcontainer);
        }

        setGuiEnabled(enabled) {
            this.ui.guiControls.forEach(c => c.disabled = !enabled);
            this.ui.rootLoginBtn.disabled = !enabled;
            this.ui.connectBtn.disabled = enabled;
            this.ui.disconnectBtn.disabled = !enabled;
            this.ui.baudRateSelect.disabled = enabled;
            this.ui.statusindicator.classList.toggle('connected', enabled);
            this.ui.statusindicator.title = enabled ? 'Connected' : 'Disconnected';
        }

        setLoading(button, isLoading) {
            if (!button) return;
            button.classList.toggle('loading', isLoading);
            button.disabled = isLoading;
            if (isLoading) {
                this.state.isCommandRunning = true;
                this.ui.guiControls.forEach(c => { if(c !== button) c.disabled = true; });
            } else {
                this.state.isCommandRunning = false;
                this.ui.guiControls.forEach(c => c.disabled = false);
            }
        }

        async sendSerial(data) {
            if (!this.state.port?.writable) return;
            try {
                const writer = this.state.port.writable.getWriter();
                await writer.write(new TextEncoder().encode(data));
                writer.releaseLock();
            } catch (e) {
                this.term.writeln(`\r\n\x1b[31m[E] Write failed: ${e.message}\x1b[0m`);
            }
        }

        async sendCommand(cmd, btn = null, showInTerm = true) {
            if (this.state.isCommandRunning || !this.state.port) return;
            this.setLoading(btn, true);
            this.term.focus();
            if (showInTerm) {
                this.term.writeln(`\x1b[38;5;69m$ ${cmd}\x1b[0m`);
            }
            await this.sendSerial(cmd + '\r');
            // A small delay to allow command to execute before re-enabling UI
            await this.delay(500);
            this.setLoading(btn, false);
        }

        delay(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        async connect() {
            if (this.state.port) return;
            this.setLoading(this.ui.connectBtn, true);
            try {
                this.state.port = await navigator.serial.requestPort();
                await this.state.port.open({ baudRate: parseInt(this.ui.baudRateSelect.value, 10) });
                this.setGuiEnabled(true);
                this.state.isReading = true;
                this.readLoop();
                this.term.writeln('\x1b[32m[SYSTEM] Connected.\x1b[0m');
                this.term.focus();
                this.onDataDisposable = this.term.onData(data => {
                    if (!this.state.fileTransfer.inProgress) {
                        this.sendSerial(data);
                    }
                });
            } catch (error) {
                this.term.writeln(`\r\n\x1b[31m[E] ${error.message}\x1b[0m`);
                this.state.port = null;
            } finally {
                this.setLoading(this.ui.connectBtn, false);
            }
        }

        async disconnect() {
            const portToClose = this.state.port;
            if (!portToClose) return;
            this.state.isReading = false;
            if (this.onDataDisposable) {
                this.onDataDisposable.dispose();
                this.onDataDisposable = null;
            }
            if (this.state.reader) {
                try { await this.state.reader.cancel(); } catch (e) { /* Ignore */ }
            }
            try { await portToClose.close(); } catch (e) { /* Ignore */ }
            if (this.state.port === portToClose) {
                this.state.port = null;
                this.state.reader = null;
                this.setGuiEnabled(false);
                this.term.writeln('\r\n\x1b[33m[SYSTEM] Disconnected.\x1b[0m');
            }
        }

        async readLoop() {
            while (this.state.port?.readable && this.state.isReading) {
                const textDecoder = new TextDecoder();
                this.state.reader = this.state.port.readable.getReader();
                try {
                    while (true) {
                        const { value, done } = await this.state.reader.read();
                        if (done) { this.state.reader.releaseLock(); break; }
                        const decodedChunk = textDecoder.decode(value, { stream: true });

                        // Process chunk for special data
                        if (this.state.fileTransfer.inProgress && this.state.fileTransfer.type === 'download') {
                            this.handleFileDownloadChunk(decodedChunk);
                        } else {
                            this.term.write(decodedChunk);
                            this.parseForPid(decodedChunk);
                        }
                    }
                } catch (error) {
                    if (this.state.isReading) this.term.writeln(`\r\n\x1b[31m[E] Read loop: ${error.message}\x1b[0m`);
                }
            }
        }

        parseForPid(text) {
            const ptpMatch = text.match(/(\d+)_PTP_PID/);
            if (ptpMatch) this.state.activeProcesses.ptp = ptpMatch[1];

            const candumpMatch = text.match(/(\d+)_CANDUMP_PID/);
            if (candumpMatch) this.state.activeProcesses.candump = candumpMatch[1];
        }

        async handleProcess(btn, processKey, command) {
            if (this.state.activeProcesses[processKey]) {
                this.term.writeln(`\x1b[33m[W] Process ${processKey} seems to be running. Stop it first.\x1b[0m`);
                return;
            }
            this.setLoading(btn, true);
            const cmd = `${command} & echo $!_${processKey.toUpperCase()}_PID`;
            await this.sendCommand(cmd, null, true);
            await this.delay(500);
            this.setLoading(btn, false);
        }

        async killProcess(btn, processKey) {
            const pid = this.state.activeProcesses[processKey];
            if (!pid) {
                this.term.writeln(`\x1b[33m[W] Process ${processKey} PID not found. Using killall as fallback.\x1b[0m`);
                await this.sendCommand(`killall ${processKey}`, btn);
            } else {
                await this.sendCommand(`kill -9 ${pid}`, btn);
                this.state.activeProcesses[processKey] = null;
            }
        }

        // --- File Transfer ---
        handleFileUpload() {
            const file = this.ui.fileInput.files[0];
            const remotePath = this.ui.remotePathInput.value.trim();
            if (!file || !remotePath) {
                this.ui.uploadStatus.textContent = "Select file and enter remote path.";
                return;
            }
            const reader = new FileReader();
            this.setLoading(this.ui.uploadFileBtn, true);
            this.ui.uploadStatus.textContent = `Reading ${file.name}...`;
            reader.onload = async (e) => {
                const base64Content = e.target.result.split(',')[1];
                this.ui.uploadStatus.textContent = `Uploading...`;
                this.ui.uploadProgressBar.style.display = 'block';

                // Chunked upload
                const chunkSize = 512; // characters
                for (let i = 0; i < base64Content.length; i += chunkSize) {
                    const chunk = base64Content.substring(i, i + chunkSize);
                    const operator = (i === 0) ? '>' : '>>';
                    const cmd = `echo -n '${chunk}' | base64 -d ${operator} ${remotePath}`;
                    await this.sendSerial(cmd + '\r');
                    await this.delay(50); // small delay between chunks
                    const progress = Math.round(((i + chunk.length) / base64Content.length) * 100);
                    this.ui.uploadProgressBar.querySelector('.progress-bar-fill').style.width = `${progress}%`;
                }

                this.ui.uploadStatus.textContent = 'Upload complete.';
                this.term.writeln(`\n\x1b[32m[SUCCESS] File uploaded to ${remotePath}\x1b[0m`);
                this.setLoading(this.ui.uploadFileBtn, false);
                setTimeout(() => { this.ui.uploadProgressBar.style.display = 'none'; }, 2000);
            };
            reader.onerror = () => {
                this.ui.uploadStatus.textContent = 'Error reading file.';
                this.setLoading(this.ui.uploadFileBtn, false);
            };
            reader.readAsDataURL(file);
        }

        handleFileDownload() {
            const path = this.ui.downloadPathInput.value.trim();
            if (!path) { this.ui.downloadStatus.textContent = 'Enter a file path.'; return; }
            if (this.state.fileTransfer.inProgress) return;

            this.setLoading(this.ui.downloadFileBtn, true);
            this.state.fileTransfer = { inProgress: true, type: 'download', buffer: '', totalSize: 0, transferredSize: 0 };

            this.ui.downloadStatus.textContent = `Requesting ${path}...`;
            this.ui.downloadProgressBar.style.display = 'block';
            this.ui.downloadProgressBar.querySelector('.progress-bar-fill').style.width = '0%';

            const cmd = `if [ -f "${path}" ]; then SIZE=$(stat -c%s "${path}"); echo "DOWNLOAD_START:$SIZE"; cat "${path}" | base64; echo "DOWNLOAD_END"; else echo "DOWNLOAD_ERROR"; fi`;
            this.sendCommand(cmd, null, false);
        }

        handleFileDownloadChunk(chunk) {
            this.state.fileTransfer.buffer += chunk;
            const startMarker = 'DOWNLOAD_START:';
            const endMarker = 'DOWNLOAD_END';
            const errorMarker = 'DOWNLOAD_ERROR';

            if (this.state.fileTransfer.totalSize === 0 && this.state.fileTransfer.buffer.includes(startMarker)) {
                const match = this.state.fileTransfer.buffer.match(/DOWNLOAD_START:(\d+)/);
                if (match && match[1]) {
                    this.state.fileTransfer.totalSize = parseInt(match[1], 10);
                    this.ui.downloadStatus.textContent = `Downloading... (Total: ${this.state.fileTransfer.totalSize} bytes)`;
                    // Clean buffer from start marker
                    this.state.fileTransfer.buffer = this.state.fileTransfer.buffer.substring(this.state.fileTransfer.buffer.indexOf('\n') + 1);
                }
            }

            if (this.state.fileTransfer.totalSize > 0) {
                // Heuristic progress update based on received base64 data length
                const approxOriginalSize = this.state.fileTransfer.buffer.length * 0.75;
                const progress = Math.min(100, Math.round((approxOriginalSize / this.state.fileTransfer.totalSize) * 100));
                this.ui.downloadProgressBar.querySelector('.progress-bar-fill').style.width = `${progress}%`;
            }

            if (this.state.fileTransfer.buffer.includes(endMarker)) {
                const fileData = this.state.fileTransfer.buffer.substring(0, this.state.fileTransfer.buffer.indexOf(endMarker)).trim();
                this.saveDownloadedFile(fileData);
                this.resetFileTransferState();
            } else if (this.state.fileTransfer.buffer.includes(errorMarker)) {
                this.term.writeln('\r\n\x1b[31m[E] Download failed: File not found on device.\x1b[0m');
                this.ui.downloadStatus.textContent = 'Download failed: File not found.';
                this.resetFileTransferState();
            }
        }

        saveDownloadedFile(base64Data) {
            try {
                this.ui.downloadStatus.textContent = 'Decoding file...';
                const byteCharacters = atob(base64Data);
                const byteArray = new Uint8Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) { byteArray[i] = byteCharacters.charCodeAt(i); }
                const blob = new Blob([byteArray]);
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const filename = this.ui.downloadPathInput.value.split('/').pop() || 'downloaded_file';
                link.download = filename;
                link.click();
                link.remove();
                this.ui.downloadStatus.textContent = `File "${filename}" downloaded.`;
            } catch (e) {
                this.term.writeln(`\r\n\x1b[31m[E] Decode/save failed: ${e.message}\x1b[0m`);
                this.ui.downloadStatus.textContent = 'Error: Failed to decode file.';
            }
        }

        resetFileTransferState() {
            this.state.fileTransfer = { inProgress: false, type: null, buffer: '', totalSize: 0, transferredSize: 0 };
            this.setLoading(this.ui.downloadFileBtn, false);
            setTimeout(() => { this.ui.downloadProgressBar.style.display = 'none'; }, 2000);
        }

        // --- Event Bindings ---
        bindEvents() {
            this.ui.connectBtn.addEventListener('click', () => this.connect());
            this.ui.disconnectBtn.addEventListener('click', () => this.disconnect());
            this.ui.clearTermBtn.addEventListener('click', () => this.term.clear());
            this.ui.rootLoginBtn.addEventListener('click', () => this.sendCommand('root', this.ui.rootLoginBtn, true));

            // Management
            this.ui.setupGmacBtn.addEventListener('click', (e) => this.sendCommand(`ip addr add 169.254.59.171/16 dev end0`, e.currentTarget));
            this.ui.pingHostBtn.addEventListener('click', (e) => this.sendCommand(`ping -c 4 169.254.59.170`, e.currentTarget));

            // TSN Demo
            this.ui.tsnDemoBtn.addEventListener('click', async (e) => {
                this.setLoading(e.currentTarget, true);
                const iface = 'end0';
                this.term.writeln('\x1b[34m[INFO] Starting One-Click TSN Demo sequence on end0...\x1b[0m');
                await this.sendCommand(`tc qdisc add dev ${iface} root handle 1: mqprio num_tc 4 map 2 2 1 1 2 2 2 2 2 2 2 2 2 2 2 2 queues 1@1 1@2 1@3 hw 0`, null, true);
                await this.delay(500);
                await this.sendCommand(`tc qdisc add dev ${iface} parent 1:2 cbs idleslope 50000 sendslope -950000 hicredit 52 locredit -144 offload 1`, null, true);
                await this.delay(500);
                await this.handleProcess(null, 'ptp', `ptp4l -i ${iface} -2 -H -m`);
                this.term.writeln('\x1b[32m[SUCCESS] TSN Demo initiated.\x1b[0m');
                this.setLoading(e.currentTarget, false);
            });
            this.ui.stopTsnDemoBtn.addEventListener('click', async (e) => {
                this.setLoading(e.currentTarget, true);
                const iface = 'end0';
                this.term.writeln('\x1b[33m[INFO] Stopping TSN Demo and cleaning up...\x1b[0m');
                await this.killProcess(null, 'ptp');
                await this.delay(200);
                await this.sendCommand(`tc qdisc del dev ${iface} root`, null, true);
                this.term.writeln('\x1b[32m[SUCCESS] Cleanup complete.\x1b[0m');
                this.setLoading(e.currentTarget, false);
            });

            // PTP
            this.ui.runPtp4lBtn.addEventListener('click', (e) => {
                const i = this.ui.ptp4lIfaceInput.value.trim(); const ts = this.ui.ptp4lTsSelect.value;
                const t = this.ui.ptp4lTransportSelect.value; const d = this.ui.ptp4lDomainInput.value.trim();
                if(i) this.handleProcess(e.currentTarget, 'ptp', `ptp4l -i ${i} ${ts} ${t} -d ${d} -m`);
            });
            this.ui.stopPtp4lBtn.addEventListener('click', (e) => this.killProcess(e.currentTarget, 'ptp'));

            // TC
            this.ui.runTcBtn.addEventListener('click', (e) => {
                const iface = this.ui.tcIfaceInput.value.trim(); const num_tc = this.ui.tcNumTcInput.value.trim();
                const sched_entries = this.ui.tcSchedEntryTextarea.value.trim().split('\n').map(line => line.trim()).filter(line => line.length > 0).join(' ');
                if (!iface || !num_tc || !sched_entries) return;
                const map_str = Array.from({length: 16}, () => 0).join(' ');
                const queues_str = Array.from({length: parseInt(num_tc)}, (_, i) => `1@${i}`).join(' ');
                const cmd = `tc qdisc replace dev ${iface} parent root handle 100 taprio num_tc ${num_tc} map ${map_str} queues ${queues_str} base-time 0 ${sched_entries} flags 0x2`;
                this.sendCommand(cmd, e.currentTarget);
            });
            this.ui.deleteTcBtn.addEventListener('click', (e) => {
                const iface = this.ui.tcIfaceInput.value.trim();
                if (iface) this.sendCommand(`tc qdisc del dev ${iface} root`, e.currentTarget);
            });

            // CAN
            this.ui.can0StatsBtn.addEventListener('click', e => this.sendCommand('ip -s link show can0', e.currentTarget));
            this.ui.can1StatsBtn.addEventListener('click', e => this.sendCommand('ip -s link show can1', e.currentTarget));
            this.ui.runCandumpBtn.addEventListener('click', e => {
                const i = this.ui.candumpInput.value.trim();
                if(i) this.handleProcess(e.currentTarget, 'candump', `candump ${i}`);
            });
            this.ui.stopCandumpBtn.addEventListener('click', e => this.killProcess(e.currentTarget, 'candump'));
            this.ui.sendCanBtn.addEventListener('click', e => {
                const c = this.ui.cansendInput.value.trim();
                if(c) this.sendCommand(`cansend ${c}`, e.currentTarget);
            });

            // File Transfer
            this.ui.uploadFileBtn.addEventListener('click', () => this.handleFileUpload());
            this.ui.downloadFileBtn.addEventListener('click', () => this.handleFileDownload());
        }
    }

    const app = new S32GControlDeck();
    app.init();
});
</script>
</body>
</html>
